
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Regression &#8212; Think Bayes</title>
    
  <link rel="stylesheet" href="_static/css/index.73d71520a4ca3b99cfee5594769eaaae.css">

    
  <link rel="stylesheet"
    href="_static/vendor/fontawesome/5.13.0/css/all.min.css">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="_static/vendor/fontawesome/5.13.0/webfonts/fa-solid-900.woff2">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="_static/vendor/fontawesome/5.13.0/webfonts/fa-brands-400.woff2">

    
      
  <link rel="stylesheet"
    href="_static/vendor/open-sans_all/1.44.1/index.css">
  <link rel="stylesheet"
    href="_static/vendor/lato_latin-ext/1.44.1/index.css">

    
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="_static/sphinx-book-theme.40e2e510f6b7d1648584402491bb10fe.css" type="text/css" />
    <link rel="stylesheet" type="text/css" href="_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="_static/mystnb.css" />
    <link rel="stylesheet" type="text/css" href="_static/sphinx-thebe.css" />
    <link rel="stylesheet" type="text/css" href="_static/panels-main.c949a650a448cc0ae9fd3441c0e17fb0.css" />
    <link rel="stylesheet" type="text/css" href="_static/panels-variables.06eb56fa6e07937060861dad626602ad.css" />
    
  <link rel="preload" as="script" href="_static/js/index.3da636dd464baa7582d2.js">

    <script id="documentation_options" data-url_root="./" src="_static/documentation_options.js"></script>
    <script src="_static/jquery.js"></script>
    <script src="_static/underscore.js"></script>
    <script src="_static/doctools.js"></script>
    <script src="_static/togglebutton.js"></script>
    <script src="_static/clipboard.min.js"></script>
    <script src="_static/copybutton.js"></script>
    <script >var togglebuttonSelector = '.toggle, .admonition.dropdown, .tag_hide_input div.cell_input, .tag_hide-input div.cell_input, .tag_hide_output div.cell_output, .tag_hide-output div.cell_output, .tag_hide_cell.cell, .tag_hide-cell.cell';</script>
    <script src="_static/sphinx-book-theme.d31b09fe5c1d09cb49b26a786de4a05d.js"></script>
    <script async="async" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.7/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <script type="text/x-mathjax-config">MathJax.Hub.Config({"tex2jax": {"inlineMath": [["\\(", "\\)"]], "displayMath": [["\\[", "\\]"]], "processRefs": false, "processEnvironments": false}})</script>
    <script async="async" src="https://unpkg.com/thebelab@latest/lib/index.js"></script>
    <script >
        const thebe_selector = ".thebe"
        const thebe_selector_input = "pre"
        const thebe_selector_output = ".output"
    </script>
    <script async="async" src="_static/sphinx-thebe.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Conjugate Priors" href="chap18.html" />
    <link rel="prev" title="Logistic regression" href="chap16.html" />

    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="docsearch:language" content="en" />



  </head>
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="80">
    

    <div class="container-xl">
      <div class="row">
          
<div class="col-12 col-md-3 bd-sidebar site-navigation show" id="site-navigation">
    
        <div class="navbar-brand-box">
<a class="navbar-brand text-wrap" href="index.html">
  
  
  <h1 class="site-logo" id="site-title">Think Bayes</h1>
  
</a>
</div><form class="bd-search d-flex align-items-center" action="search.html" method="get">
  <i class="icon fas fa-search"></i>
  <input type="search" class="form-control" name="q" id="search-input" placeholder="Search this book..." aria-label="Search this book..." autocomplete="off" >
</form>
<nav class="bd-links" id="bd-docs-nav" aria-label="Main navigation">
    <ul class="nav sidenav_l1">
 <li class="toctree-l1">
  <a class="reference internal" href="README.html">
   ThinkBayes2
  </a>
 </li>
</ul>
<ul class="current nav sidenav_l1">
 <li class="toctree-l1">
  <a class="reference internal" href="chap01.html">
   Probability
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="chap02.html">
   Bayes’s Theorem
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="chap03.html">
   Distributions
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="chap04.html">
   Estimating proportions
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="chap05.html">
   Estimating counts
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="chap06.html">
   Odds and Addends
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="chap07.html">
   Minimum, maximum, and mixture
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="chap08.html">
   Poisson Processes
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="chap09.html">
   Decision Analysis
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="chap10.html">
   Testing
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="chap11.html">
   Comparison
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="chap12.html">
   Classification
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="chap13.html">
   Inference
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="chap14.html">
   Survival Analysis
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="chap15.html">
   Mark and Recapture
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="chap16.html">
   Logistic regression
  </a>
 </li>
 <li class="toctree-l1 current active">
  <a class="current reference internal" href="#">
   Regression
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="chap18.html">
   Conjugate Priors
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="chap19.html">
   MCMC
  </a>
 </li>
</ul>

</nav> <!-- To handle the deprecated key -->

<div class="navbar_extra_footer">
  Powered by <a href="https://jupyterbook.org">Jupyter Book</a>
</div>

</div>


          


          
<main class="col py-md-3 pl-md-4 bd-content overflow-auto" role="main">
    
    <div class="row topbar fixed-top container-xl">
    <div class="col-12 col-md-3 bd-topbar-whitespace site-navigation show">
    </div>
    <div class="col pl-2 topbar-main">
        
        <button id="navbar-toggler" class="navbar-toggler ml-0" type="button" data-toggle="collapse"
            data-toggle="tooltip" data-placement="bottom" data-target=".site-navigation" aria-controls="navbar-menu"
            aria-expanded="true" aria-label="Toggle navigation" aria-controls="site-navigation"
            title="Toggle navigation" data-toggle="tooltip" data-placement="left">
            <i class="fas fa-bars"></i>
            <i class="fas fa-arrow-left"></i>
            <i class="fas fa-arrow-up"></i>
        </button>
        
        
<div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn" aria-label="Download this page"><i
            class="fas fa-download"></i></button>

    <div class="dropdown-buttons">
        <!-- ipynb file if we had a myst markdown file -->
        
        <!-- Download raw file -->
        <a class="dropdown-buttons" href="_sources/chap17.ipynb"><button type="button"
                class="btn btn-secondary topbarbtn" title="Download source file" data-toggle="tooltip"
                data-placement="left">.ipynb</button></a>
        <!-- Download PDF via print -->
        <button type="button" id="download-print" class="btn btn-secondary topbarbtn" title="Print to PDF"
            onClick="window.print()" data-toggle="tooltip" data-placement="left">.pdf</button>
    </div>
</div>

        <!-- Source interaction buttons -->

<div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn"
        aria-label="Connect with source repository"><i class="fab fa-github"></i></button>
    <div class="dropdown-buttons sourcebuttons">
        <a class="repository-button"
            href="https://github.com/AllenDowney/ThinkBayes2"><button type="button" class="btn btn-secondary topbarbtn"
                data-toggle="tooltip" data-placement="left" title="Source repository"><i
                    class="fab fa-github"></i>repository</button></a>
        
        
    </div>
</div>


        <!-- Full screen (wrap in <a> to have style consistency -->
        <a class="full-screen-button"><button type="button" class="btn btn-secondary topbarbtn" data-toggle="tooltip"
                data-placement="bottom" onclick="toggleFullScreen()" aria-label="Fullscreen mode"
                title="Fullscreen mode"><i
                    class="fas fa-expand"></i></button></a>

        <!-- Launch buttons -->

<div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn"
        aria-label="Launch interactive content"><i class="fas fa-rocket"></i></button>
    <div class="dropdown-buttons">
        
        <a class="binder-button" href="https://mybinder.org/v2/gh/AllenDowney/ThinkBayes2/master?urlpath=tree/chap17.ipynb"><button type="button"
                class="btn btn-secondary topbarbtn" title="Launch Binder" data-toggle="tooltip"
                data-placement="left"><img class="binder-button-logo"
                    src="_static/images/logo_binder.svg"
                    alt="Interact on binder">Binder</button></a>
        
        
        
        
    </div>
</div>

    </div>

    <!-- Table of contents -->
    <div class="d-none d-md-block col-md-2 bd-toc show">
        
        <div class="tocsection onthispage pt-5 pb-3">
            <i class="fas fa-list"></i> Contents
        </div>
        <nav id="bd-toc-nav">
            <ul class="nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#more-snow">
   More snow?
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#regression-model">
   Regression model
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#least-squares-regression">
   Least squares regression
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#likelihood">
   Likelihood
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#priors">
   Priors
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#the-update">
   The Update
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#unpacking-the-marginals">
   Unpacking the Marginals
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#optimization">
   Optimization
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#marathon-world-record">
   Marathon world record
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#the-priors">
   The priors
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#prediction">
   Prediction
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#summary">
   Summary
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#exercises">
   Exercises
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#gss-data">
   GSS data
  </a>
 </li>
</ul>

        </nav>
        
    </div>
</div>
    <div id="main-content" class="row">
        <div class="col-12 col-md-9 pl-md-3 pr-md-0">
        
              <div>
                
  <div class="section" id="regression">
<h1>Regression<a class="headerlink" href="#regression" title="Permalink to this headline">¶</a></h1>
<p>In the previous chapter we saw several examples of logistic regression, which is based on the assumption that the likelihood of an outcome, expressed in the form of log odds, is a linear function of some quantity (continuous or discrete).</p>
<p>In this chapter we’ll work on examples of simple linear regression, which models the relationship between two quantities.  Specifically, we’ll look at changes over time in snowfall and the marathon world record.</p>
<p>The models we’ll use have three parameters, so you might want to review the tools we used for the three-parameter model in Chapter xxx.</p>
<div class="section" id="more-snow">
<h2>More snow?<a class="headerlink" href="#more-snow" title="Permalink to this headline">¶</a></h2>
<p>I am under the impression that we don’t get as much snow around here as we used to.  By “around here” I mean Norfolk County, Massachusetts, where I was born, grew up, and currently live.  And by “used to” I mean compared to when I was young, like in 1978 when we got <a class="reference external" href="https://en.wikipedia.org/wiki/Northeastern_United_States_blizzard_of_1978">27 inches of snow</a> and I didn’t have to go to school for a couple of weeks.</p>
<p>Fortunately, we can test my conjecture with data.  Norfolk County happens to be the location of the <a class="reference external" href="https://en.wikipedia.org/wiki/Blue_Hill_Meteorological_Observatory">Blue Hill Meteorological Observatory</a>, which keeps the oldest continuous weather record in North America.</p>
<p>Data from this and many other weather stations is available from the <a class="reference external" href="https://www.ncdc.noaa.gov/cdo-web/search">National Oceanic and Atmospheric Administration</a> (NOAA).  I collected data from the Blue Hill Observatory from May 11, 1967 to May 11, 2020.  The following cell downloads the data as a CSV file.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">os</span>

<span class="n">datafile</span> <span class="o">=</span> <span class="s1">&#39;2239075.csv&#39;</span>
<span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">datafile</span><span class="p">):</span>
    <span class="o">!</span>wget https://github.com/AllenDowney/ThinkBayes2/raw/master/data/2239075.csv
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>--2020-12-23 10:19:02--  https://github.com/AllenDowney/ThinkBayes2/raw/master/data/2239075.csv
Resolving github.com (github.com)... 140.82.114.3
Connecting to github.com (github.com)|140.82.114.3|:443... connected.
HTTP request sent, awaiting response... 302 Found
Location: https://raw.githubusercontent.com/AllenDowney/ThinkBayes2/master/data/2239075.csv [following]
--2020-12-23 10:19:03--  https://raw.githubusercontent.com/AllenDowney/ThinkBayes2/master/data/2239075.csv
Resolving raw.githubusercontent.com (raw.githubusercontent.com)... 151.101.116.133
Connecting to raw.githubusercontent.com (raw.githubusercontent.com)|151.101.116.133|:443... connected.
HTTP request sent, awaiting response... 200 OK
Length: 1853619 (1.8M) [text/plain]
Saving to: ‘2239075.csv’

2239075.csv         100%[===================&gt;]   1.77M  8.75MB/s    in 0.2s    

2020-12-23 10:19:03 (8.75 MB/s) - ‘2239075.csv’ saved [1853619/1853619]
</pre></div>
</div>
</div>
</div>
<p>We can read the data into a Pandas <code class="docutils literal notranslate"><span class="pre">DataFrame</span></code>:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>

<span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s1">&#39;2239075.csv&#39;</span><span class="p">,</span> <span class="n">parse_dates</span><span class="o">=</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
</pre></div>
</div>
</div>
</div>
<p>Here’s what the last few rows look like.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df</span><span class="o">.</span><span class="n">tail</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>STATION</th>
      <th>NAME</th>
      <th>DATE</th>
      <th>PRCP</th>
      <th>SNOW</th>
      <th>SNWD</th>
      <th>TMAX</th>
      <th>TMIN</th>
      <th>TOBS</th>
      <th>WESD</th>
      <th>WT01</th>
      <th>WT03</th>
      <th>WT04</th>
      <th>WT05</th>
      <th>WT06</th>
      <th>WT08</th>
      <th>WT09</th>
      <th>WT11</th>
      <th>WT16</th>
      <th>WT18</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>19357</th>
      <td>USC00190736</td>
      <td>BLUE HILL COOP, MA US</td>
      <td>2020-05-09</td>
      <td>0.45</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>57</td>
      <td>34.0</td>
      <td>34.0</td>
      <td>NaN</td>
      <td>1.0</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>19358</th>
      <td>USC00190736</td>
      <td>BLUE HILL COOP, MA US</td>
      <td>2020-05-10</td>
      <td>0.00</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>44</td>
      <td>31.0</td>
      <td>38.0</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>19359</th>
      <td>USC00190736</td>
      <td>BLUE HILL COOP, MA US</td>
      <td>2020-05-11</td>
      <td>0.00</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>59</td>
      <td>38.0</td>
      <td>50.0</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<p>I’ll add a column that contains just the year part of the dates.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;YEAR&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;DATE&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">year</span>
</pre></div>
</div>
</div>
</div>
<p>And use <code class="docutils literal notranslate"><span class="pre">groupby</span></code> to add up the total snowfall in each year.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">snow</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;YEAR&#39;</span><span class="p">)[</span><span class="s1">&#39;SNOW&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
<span class="nb">len</span><span class="p">(</span><span class="n">snow</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>54
</pre></div>
</div>
</div>
</div>
<p>The first and last years are not complete, so I’ll drop them.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">complete</span> <span class="o">=</span> <span class="n">snow</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
<span class="nb">len</span><span class="p">(</span><span class="n">complete</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>52
</pre></div>
</div>
</div>
</div>
<p>The following figure shows total snowfall during each of the complete years in my lifetime.</p>
<div class="cell tag_hide-input docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">utils</span> <span class="kn">import</span> <span class="n">decorate</span>

<span class="n">complete</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">style</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>

<span class="n">decorate</span><span class="p">(</span><span class="n">xlabel</span><span class="o">=</span><span class="s1">&#39;Year&#39;</span><span class="p">,</span>
         <span class="n">ylabel</span><span class="o">=</span><span class="s1">&#39;Total annual snowfall (inches)&#39;</span><span class="p">,</span>
         <span class="n">title</span><span class="o">=</span><span class="s1">&#39;Total annual snowfall in Norfolk County, MA&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/chap17_19_0.png" src="_images/chap17_19_0.png" />
</div>
</div>
<p>Looking at this plot, it’s hard to say whether snowfall is increasing, decreasing, or unchanged.  In the last decade, we’ve had several years with more snow than 1978, including 2015, which was the snowiest winter in the Boston area in modern history, with a total of 141 inches.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">complete</span><span class="o">.</span><span class="n">loc</span><span class="p">[[</span><span class="mi">1978</span><span class="p">,</span> <span class="mi">1996</span><span class="p">,</span> <span class="mi">2015</span><span class="p">]]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>YEAR
1978    100.6
1996    124.2
2015    141.1
Name: SNOW, dtype: float64
</pre></div>
</div>
</div>
</div>
<p>This kind of question – looking at noisy data and wondering whether it is going up or down – is precisely the question we can answer with Bayesian regression.</p>
</div>
<div class="section" id="regression-model">
<h2>Regression model<a class="headerlink" href="#regression-model" title="Permalink to this headline">¶</a></h2>
<p>The foundation of regression (Bayesian or not) is the model that a time series like this is the sum of two parts:</p>
<ol class="simple">
<li><p>A linear function of time, and</p></li>
<li><p>A series of random values drawn from a distribution that is not changing over time.</p></li>
</ol>
<p>Mathematically,</p>
<div class="math notranslate nohighlight">
\[y = a x + b + \epsilon\]</div>
<p>where <span class="math notranslate nohighlight">\(y\)</span> is the series of measurements (snowfall in this example), <span class="math notranslate nohighlight">\(x\)</span> is the series of times (years) and <span class="math notranslate nohighlight">\(\epsilon\)</span> is the series of random values.</p>
<p><span class="math notranslate nohighlight">\(a\)</span> and <span class="math notranslate nohighlight">\(b\)</span> are the slope and intercept of the line through the data.  They are unknown parameters, so we will use the data to estimate them.</p>
<p>We don’t know the distribution of <span class="math notranslate nohighlight">\(\epsilon\)</span>, so we’ll make the additional assumption that it is a normal distribution with mean 0 and unknown standard deviation, <span class="math notranslate nohighlight">\(\sigma\)</span>.</p>
<p>To see whether this assumption is reasonable, I’ll plot the distribution of total snowfall and a normal model with the same mean and standard deviations.</p>
<p>Here’s a <code class="docutils literal notranslate"><span class="pre">Pmf</span></code> object that represents the distribution of snowfall.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">empiricaldist</span> <span class="kn">import</span> <span class="n">Pmf</span>

<span class="n">pmf_snowfall</span> <span class="o">=</span> <span class="n">Pmf</span><span class="o">.</span><span class="n">from_seq</span><span class="p">(</span><span class="n">complete</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>And here are the mean and standard deviation of the data.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">mean</span><span class="p">,</span> <span class="n">std</span> <span class="o">=</span> <span class="n">pmf_snowfall</span><span class="o">.</span><span class="n">mean</span><span class="p">(),</span> <span class="n">pmf_snowfall</span><span class="o">.</span><span class="n">std</span><span class="p">()</span>
<span class="n">mean</span><span class="p">,</span> <span class="n">std</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>(64.19038461538462, 26.288021984395684)
</pre></div>
</div>
</div>
</div>
<p>I’ll use the <code class="docutils literal notranslate"><span class="pre">norm</span></code> object from SciPy to compute the CDF of the a normal distribution with the same mean and standard deviation.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">scipy.stats</span> <span class="kn">import</span> <span class="n">norm</span>

<span class="n">dist</span> <span class="o">=</span> <span class="n">norm</span><span class="p">(</span><span class="n">mean</span><span class="p">,</span> <span class="n">std</span><span class="p">)</span>
<span class="n">qs</span> <span class="o">=</span> <span class="n">pmf_snowfall</span><span class="o">.</span><span class="n">qs</span>
<span class="n">ps</span> <span class="o">=</span> <span class="n">dist</span><span class="o">.</span><span class="n">cdf</span><span class="p">(</span><span class="n">qs</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Here’s what the distribution of the data looks like compared to the normal model.</p>
<div class="cell tag_hide-input docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>

<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">qs</span><span class="p">,</span> <span class="n">ps</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;C5&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;model&#39;</span><span class="p">)</span>
<span class="n">pmf_snowfall</span><span class="o">.</span><span class="n">make_cdf</span><span class="p">()</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="s1">&#39;data&#39;</span><span class="p">)</span>

<span class="n">decorate</span><span class="p">(</span><span class="n">xlabel</span><span class="o">=</span><span class="s1">&#39;Total snowfall (inches)&#39;</span><span class="p">,</span>
         <span class="n">ylabel</span><span class="o">=</span><span class="s1">&#39;CDF&#39;</span><span class="p">,</span>
         <span class="n">title</span><span class="o">=</span><span class="s1">&#39;Normal model of variation in snowfall&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/chap17_30_0.png" src="_images/chap17_30_0.png" />
</div>
</div>
<p>We’ve had more winters below the mean than expected, but overall this looks like a reasonable model.</p>
</div>
<div class="section" id="least-squares-regression">
<h2>Least squares regression<a class="headerlink" href="#least-squares-regression" title="Permalink to this headline">¶</a></h2>
<p>Our regression model has three parameters: slope, intercept, and standard deviation of <span class="math notranslate nohighlight">\(\epsilon\)</span>.
Before we can estimate them, we have to choose priors.</p>
<p>To help with that, I’ll use StatsModel to fit a line to the data by <a class="reference external" href="https://en.wikipedia.org/wiki/Least_squares">least squares regression</a>.</p>
<p>First, I’ll use <code class="docutils literal notranslate"><span class="pre">reset_index</span></code> to convert <code class="docutils literal notranslate"><span class="pre">complete</span></code>, which is a <code class="docutils literal notranslate"><span class="pre">Series</span></code>, to a <code class="docutils literal notranslate"><span class="pre">DataFrame</span></code>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">data</span> <span class="o">=</span> <span class="n">complete</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
<span class="n">data</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>YEAR</th>
      <th>SNOW</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>1968</td>
      <td>44.7</td>
    </tr>
    <tr>
      <th>1</th>
      <td>1969</td>
      <td>99.2</td>
    </tr>
    <tr>
      <th>2</th>
      <td>1970</td>
      <td>66.8</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<p>The result is a <code class="docutils literal notranslate"><span class="pre">DataFrame</span></code> with two columns, <code class="docutils literal notranslate"><span class="pre">YEAR</span></code> and <code class="docutils literal notranslate"><span class="pre">SNOW</span></code>, in a format we can use with StatsModels.</p>
<p>As we did in the previous chapter, I’ll center the data by subtracting off the mean.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">offset</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;YEAR&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
<span class="n">offset</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>1993.5
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;YEAR&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">offset</span>
<span class="n">data</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>0.0
</pre></div>
</div>
</div>
</div>
<p>And I’ll add a column to <code class="docutils literal notranslate"><span class="pre">data</span></code> so the dependent variable has a standard name.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;SNOW&#39;</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<p>Now, we can use StatsModels to compute the least squares fit to the data and estimate <code class="docutils literal notranslate"><span class="pre">slope</span></code> and <code class="docutils literal notranslate"><span class="pre">intercept</span></code>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">statsmodels.formula.api</span> <span class="k">as</span> <span class="nn">smf</span>

<span class="n">formula</span> <span class="o">=</span> <span class="s1">&#39;y ~ x&#39;</span>
<span class="n">results</span> <span class="o">=</span> <span class="n">smf</span><span class="o">.</span><span class="n">ols</span><span class="p">(</span><span class="n">formula</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">)</span><span class="o">.</span><span class="n">fit</span><span class="p">()</span>
<span class="n">results</span><span class="o">.</span><span class="n">params</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Intercept    64.190385
x             0.511880
dtype: float64
</pre></div>
</div>
</div>
</div>
<p>The intercept, about 64 inches, is the expected snowfall when <code class="docutils literal notranslate"><span class="pre">x=0</span></code>, which is the middle of 1993.</p>
<p>The estimated slope indicates that total snowfall is increasing at a rate of about 0.5 inches per year.</p>
<p><code class="docutils literal notranslate"><span class="pre">results</span></code> also provides <code class="docutils literal notranslate"><span class="pre">resid</span></code>, which is an array of residuals, that is, the differences between the data and the fitted line.
The standard deviation of the residuals is an estimate of <code class="docutils literal notranslate"><span class="pre">sigma</span></code>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">results</span><span class="o">.</span><span class="n">resid</span><span class="o">.</span><span class="n">std</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>25.385680731210616
</pre></div>
</div>
</div>
</div>
<p>We’ll use these estimates to choose prior distributions for the parameters.</p>
<p>But first, I’ll use them to demonstrate how we compute the likelihood of the data.</p>
</div>
<div class="section" id="likelihood">
<h2>Likelihood<a class="headerlink" href="#likelihood" title="Permalink to this headline">¶</a></h2>
<p>Here are approximate values for the slope, intercept, and standard deviation of the data.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">inter</span> <span class="o">=</span> <span class="mi">64</span>
<span class="n">slope</span> <span class="o">=</span> <span class="mf">0.51</span>
<span class="n">sigma</span> <span class="o">=</span> <span class="mi">25</span>
</pre></div>
</div>
</div>
</div>
<p>I’ll extract the <code class="docutils literal notranslate"><span class="pre">xs</span></code> and <code class="docutils literal notranslate"><span class="pre">ys</span></code> from <code class="docutils literal notranslate"><span class="pre">data</span></code> as <code class="docutils literal notranslate"><span class="pre">Series</span></code> objects:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">xs</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">]</span>
<span class="n">ys</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<p>And compute the “residuals”, which are the differences between the actual values, <code class="docutils literal notranslate"><span class="pre">ys</span></code>, and the values we expect based on <code class="docutils literal notranslate"><span class="pre">slope</span></code> and <code class="docutils literal notranslate"><span class="pre">inter</span></code>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">expected</span> <span class="o">=</span> <span class="n">slope</span> <span class="o">*</span> <span class="n">xs</span> <span class="o">+</span> <span class="n">inter</span>
<span class="n">resid</span> <span class="o">=</span> <span class="n">ys</span> <span class="o">-</span> <span class="n">expected</span>
<span class="n">resid</span><span class="o">.</span><span class="n">describe</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>count    52.000000
mean      0.190385
std      25.385697
min     -42.335000
25%     -17.442500
50%      -6.565000
75%      14.125000
max      66.135000
dtype: float64
</pre></div>
</div>
</div>
</div>
<p>According to the model, the residuals should follow a normal distribution with mean 0 and standard deviation <code class="docutils literal notranslate"><span class="pre">sigma</span></code>.  We can compute the likelihood of each residual value using <code class="docutils literal notranslate"><span class="pre">norm</span></code> from <code class="docutils literal notranslate"><span class="pre">SciPy</span></code>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">densities</span> <span class="o">=</span> <span class="n">norm</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">sigma</span><span class="p">)</span><span class="o">.</span><span class="n">pdf</span><span class="p">(</span><span class="n">resid</span><span class="p">)</span>
<span class="n">densities</span><span class="o">.</span><span class="n">shape</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>(52,)
</pre></div>
</div>
</div>
</div>
<p>The result is an array of probability densities.
The likelihood of the data is the product of the values in this array.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">likelihood</span> <span class="o">=</span> <span class="n">densities</span><span class="o">.</span><span class="n">prod</span><span class="p">()</span>
<span class="n">likelihood</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>1.364365526172151e-105
</pre></div>
</div>
</div>
</div>
<p>As we saw in the previous chapter, the likelihood of any particular dataset tends to be small.
If it’s too small, we might exceed the limits of floating-point arithmetic.
When that happens, we can avoid the problem by computing likelihoods under a log transform.
But in this example that’s not necessary.</p>
</div>
<div class="section" id="priors">
<h2>Priors<a class="headerlink" href="#priors" title="Permalink to this headline">¶</a></h2>
<p>Now that we have figured out the likelihood function, all we need is a prior distribution.</p>
<p>I’ll use uniform distributions for all three parameters, using the parameters of the least squares fit as a starting place.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">utils</span> <span class="kn">import</span> <span class="n">make_uniform</span>

<span class="n">qs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">1.5</span><span class="p">,</span> <span class="mi">51</span><span class="p">)</span>
<span class="n">prior_slope</span> <span class="o">=</span> <span class="n">make_uniform</span><span class="p">(</span><span class="n">qs</span><span class="p">,</span> <span class="s1">&#39;Slope&#39;</span><span class="p">)</span>
<span class="n">prior_slope</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Slope
-0.50    0.019608
-0.46    0.019608
-0.42    0.019608
-0.38    0.019608
-0.34    0.019608
dtype: float64
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">qs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">54</span><span class="p">,</span> <span class="mi">75</span><span class="p">,</span> <span class="mi">41</span><span class="p">)</span>
<span class="n">prior_inter</span> <span class="o">=</span> <span class="n">make_uniform</span><span class="p">(</span><span class="n">qs</span><span class="p">,</span> <span class="s1">&#39;Intercept&#39;</span><span class="p">)</span>
<span class="n">prior_inter</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Intercept
54.000    0.02439
54.525    0.02439
55.050    0.02439
55.575    0.02439
56.100    0.02439
dtype: float64
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">qs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">20</span><span class="p">,</span> <span class="mi">35</span><span class="p">,</span> <span class="mi">31</span><span class="p">)</span>
<span class="n">prior_sigma</span> <span class="o">=</span> <span class="n">make_uniform</span><span class="p">(</span><span class="n">qs</span><span class="p">,</span> <span class="s1">&#39;Sigma&#39;</span><span class="p">)</span>
<span class="n">prior_sigma</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Sigma
20.0    0.032258
20.5    0.032258
21.0    0.032258
21.5    0.032258
22.0    0.032258
dtype: float64
</pre></div>
</div>
</div>
</div>
<p>I made the prior distributions different lengths for two reasons.  First, if we make a mistake and use the wrong distribution, it will be easier to catch the error if they are all different lengths.</p>
<p>Second, it provides more precision for the most important parameter, <code class="docutils literal notranslate"><span class="pre">slope</span></code>, and spends less computational effort on the least important, <code class="docutils literal notranslate"><span class="pre">sigma</span></code>.</p>
<p>In Chapter xxx we made a joint distribution with three parameters.  I’ll wrap that process in a function:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">utils</span> <span class="kn">import</span> <span class="n">make_joint</span>

<span class="k">def</span> <span class="nf">make_joint3</span><span class="p">(</span><span class="n">pmf1</span><span class="p">,</span> <span class="n">pmf2</span><span class="p">,</span> <span class="n">pmf3</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Make a joint distribution with three parameters.</span>
<span class="sd">    </span>
<span class="sd">    pmf1: Pmf object</span>
<span class="sd">    pmf2: Pmf object</span>
<span class="sd">    pmf3: Pmf object</span>
<span class="sd">    </span>
<span class="sd">    returns: Pmf representing a joint distribution</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">joint2</span> <span class="o">=</span> <span class="n">make_joint</span><span class="p">(</span><span class="n">pmf2</span><span class="p">,</span> <span class="n">pmf1</span><span class="p">)</span><span class="o">.</span><span class="n">stack</span><span class="p">()</span>
    <span class="n">joint3</span> <span class="o">=</span> <span class="n">make_joint</span><span class="p">(</span><span class="n">pmf3</span><span class="p">,</span> <span class="n">joint2</span><span class="p">)</span><span class="o">.</span><span class="n">stack</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">Pmf</span><span class="p">(</span><span class="n">joint3</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">prior3</span> <span class="o">=</span> <span class="n">make_joint3</span><span class="p">(</span><span class="n">prior_slope</span><span class="p">,</span> <span class="n">prior_inter</span><span class="p">,</span> <span class="n">prior_sigma</span><span class="p">)</span>
<span class="n">prior3</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Slope  Intercept  Sigma
-0.5   54.0       20.0     0.000015
                  20.5     0.000015
                  21.0     0.000015
dtype: float64
</pre></div>
</div>
</div>
</div>
<p>The result is a <code class="docutils literal notranslate"><span class="pre">Pmf</span></code> that represents the joint prior distribution of the three parameters.
Its index has three columns, containing values of <code class="docutils literal notranslate"><span class="pre">slope</span></code>, <code class="docutils literal notranslate"><span class="pre">inter</span></code>, and <code class="docutils literal notranslate"><span class="pre">sigma</span></code>, in that order.</p>
<p>With three parameters, the size of the joint distribution starts to get big.  Specifically, it is the product of the lengths of the prior distributions.  In this example, the prior distributions have 51, 41, and 31 values, so the length of the joint prior is 64,821.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">len</span><span class="p">(</span><span class="n">prior_slope</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">prior_inter</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">prior_sigma</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>(51, 41, 31)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">len</span><span class="p">(</span><span class="n">prior_slope</span><span class="p">)</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">prior_inter</span><span class="p">)</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">prior_sigma</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>64821
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">len</span><span class="p">(</span><span class="n">prior3</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>64821
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="the-update">
<h2>The Update<a class="headerlink" href="#the-update" title="Permalink to this headline">¶</a></h2>
<p>Now we’re ready to do a Bayesian update.  First, we need to compute the likelihood of the data for each possible set of parameters.</p>
<p>The following function takes the joint prior distribution and the data, computes the likelihoods, and returns the posterior distribution.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">update_regression</span><span class="p">(</span><span class="n">prior</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Posterior distribution of regression parameters</span>
<span class="sd">    `slope`, `inter`, and `sigma`.</span>
<span class="sd">    </span>
<span class="sd">    prior: Pmf representing the joint prior</span>
<span class="sd">    data: DataFrame with columns `x` and `y`</span>
<span class="sd">    </span>
<span class="sd">    returns: Pmf representing the joint posterior</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">xs</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">]</span>
    <span class="n">ys</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">]</span>
    <span class="n">likelihood</span> <span class="o">=</span> <span class="n">prior</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

    <span class="k">for</span> <span class="n">slope</span><span class="p">,</span> <span class="n">inter</span><span class="p">,</span> <span class="n">sigma</span> <span class="ow">in</span> <span class="n">prior</span><span class="o">.</span><span class="n">index</span><span class="p">:</span>
        <span class="n">expected</span> <span class="o">=</span> <span class="n">slope</span> <span class="o">*</span> <span class="n">xs</span> <span class="o">+</span> <span class="n">inter</span>
        <span class="n">resid</span> <span class="o">=</span> <span class="n">ys</span> <span class="o">-</span> <span class="n">expected</span>
        <span class="n">densities</span> <span class="o">=</span> <span class="n">norm</span><span class="o">.</span><span class="n">pdf</span><span class="p">(</span><span class="n">resid</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">sigma</span><span class="p">)</span>
        <span class="n">likelihood</span><span class="p">[</span><span class="n">slope</span><span class="p">,</span> <span class="n">inter</span><span class="p">,</span> <span class="n">sigma</span><span class="p">]</span> <span class="o">=</span> <span class="n">densities</span><span class="o">.</span><span class="n">prod</span><span class="p">()</span>
        
    <span class="n">posterior</span> <span class="o">=</span> <span class="n">prior</span> <span class="o">*</span> <span class="n">likelihood</span>
    <span class="n">posterior</span><span class="o">.</span><span class="n">normalize</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">posterior</span>
</pre></div>
</div>
</div>
</div>
<p>Here’s how we run it.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%</span><span class="k">time</span> posterior = update_regression(prior3, data)
<span class="n">posterior</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>CPU times: user 46.4 s, sys: 113 ms, total: 46.5 s
Wall time: 46.6 s
</pre></div>
</div>
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Slope  Intercept  Sigma
-0.5   54.0       20.0     4.651041e-15
                  20.5     2.658295e-14
                  21.0     1.265641e-13
                  21.5     5.111749e-13
                  22.0     1.779767e-12
dtype: float64
</pre></div>
</div>
</div>
</div>
<p>With three parameters, this function takes some time to run, but soon we’ll see a way to speed it up.</p>
<p>The result is a <code class="docutils literal notranslate"><span class="pre">Pmf</span></code> with a three-level index containing values of <code class="docutils literal notranslate"><span class="pre">slope</span></code>, <code class="docutils literal notranslate"><span class="pre">inter</span></code>, and <code class="docutils literal notranslate"><span class="pre">sigma</span></code>.</p>
</div>
<div class="section" id="unpacking-the-marginals">
<h2>Unpacking the Marginals<a class="headerlink" href="#unpacking-the-marginals" title="Permalink to this headline">¶</a></h2>
<p>To get the marginal distributions from the joint posterior, we can use <code class="docutils literal notranslate"><span class="pre">pmf_marginal</span></code>, which we saw in Chapter xxx.</p>
<p>Here’s the posterior distribution for <code class="docutils literal notranslate"><span class="pre">sigma</span></code>:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">utils</span> <span class="kn">import</span> <span class="n">pmf_marginal</span>

<span class="n">posterior_sigma</span> <span class="o">=</span> <span class="n">pmf_marginal</span><span class="p">(</span><span class="n">posterior</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell tag_hide-input docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">posterior_sigma</span><span class="o">.</span><span class="n">plot</span><span class="p">()</span>

<span class="n">decorate</span><span class="p">(</span><span class="n">xlabel</span><span class="o">=</span><span class="s1">&#39;$\sigma$, standard deviation of $\epsilon$&#39;</span><span class="p">,</span>
         <span class="n">ylabel</span><span class="o">=</span><span class="s1">&#39;PDF&#39;</span><span class="p">,</span>
         <span class="n">title</span><span class="o">=</span><span class="s1">&#39;Posterior marginal distribution of $\sigma$&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/chap17_74_0.png" src="_images/chap17_74_0.png" />
</div>
</div>
<p>The most likely values for <code class="docutils literal notranslate"><span class="pre">sigma</span></code> are near 26 inches, which is consistent with our estimate based on the standard deviation of the data.</p>
<p>However, to say whether snowfall is increasing or decreasing, we don’t really care about <code class="docutils literal notranslate"><span class="pre">sigma</span></code>.  It is a “nuisance parameter”, so-called because we have to estimate it as part of the model, but we don’t need it to answer the questions we are interested in.</p>
<p>Nevertheless, it is good to check the marginal distributions to make sure</p>
<ul class="simple">
<li><p>The location and shape are consistent with our expectations, and</p></li>
<li><p>The posterior probabilities are near 0 at the extremes of the range, which indicates that the prior distribution covers all parameters with non-negligible probability.</p></li>
</ul>
<p>In this example, the posterior distribution of <code class="docutils literal notranslate"><span class="pre">sigma</span></code> looks fine.</p>
<p>We can use <code class="docutils literal notranslate"><span class="pre">pmf_marginal</span></code> again to get the other marginal distributions.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">posterior_slope</span> <span class="o">=</span> <span class="n">pmf_marginal</span><span class="p">(</span><span class="n">posterior</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
<span class="n">posterior_inter</span> <span class="o">=</span> <span class="n">pmf_marginal</span><span class="p">(</span><span class="n">posterior</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Here’s the posterior distribution of <code class="docutils literal notranslate"><span class="pre">inter</span></code>:</p>
<div class="cell tag_hide-input docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">posterior_inter</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;C1&#39;</span><span class="p">)</span>
<span class="n">decorate</span><span class="p">(</span><span class="n">xlabel</span><span class="o">=</span><span class="s1">&#39;intercept (inches)&#39;</span><span class="p">,</span>
         <span class="n">ylabel</span><span class="o">=</span><span class="s1">&#39;PDF&#39;</span><span class="p">,</span>
         <span class="n">title</span><span class="o">=</span><span class="s1">&#39;Posterior marginal distribution of intercept&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/chap17_78_0.png" src="_images/chap17_78_0.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">utils</span> <span class="kn">import</span> <span class="n">summarize</span>
    
<span class="n">summarize</span><span class="p">(</span><span class="n">posterior_inter</span><span class="p">)</span> 
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>64.201 [58.2   70.275]
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">offset</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>1993.5
</pre></div>
</div>
</div>
</div>
<p>The posterior mean is about 64 inches, which the expected amount of snow during the year at the midpoint of the range, 1993.</p>
<p>And finally, here’s the posterior distribution of <code class="docutils literal notranslate"><span class="pre">slope</span></code>:</p>
<div class="cell tag_hide-input docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">posterior_slope</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;C4&#39;</span><span class="p">)</span>
<span class="n">decorate</span><span class="p">(</span><span class="n">xlabel</span><span class="o">=</span><span class="s1">&#39;Slope (inches per year)&#39;</span><span class="p">,</span>
         <span class="n">ylabel</span><span class="o">=</span><span class="s1">&#39;PDF&#39;</span><span class="p">,</span>
         <span class="n">title</span><span class="o">=</span><span class="s1">&#39;Posterior marginal distribution of slope&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/chap17_82_0.png" src="_images/chap17_82_0.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">summarize</span><span class="p">(</span><span class="n">posterior_slope</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>0.512 [0.1 0.9]
</pre></div>
</div>
</div>
</div>
<p>The posterior mean is about 0.51 inches, which is consistent with the estimate we got from least squared regression.</p>
<p>The 90% credible interval is from 0.1 to 0.9, which indicates that our uncertainty about this estimate is pretty high.  In fact, there is still a small posterior probability (about 2%) that the slope is negative.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">posterior_slope</span><span class="o">.</span><span class="n">make_cdf</span><span class="p">()(</span><span class="mi">0</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>array(0.01840785)
</pre></div>
</div>
</div>
</div>
<p>However, it is more likely that my conjecture was wrong: we are actually getting more snow around here than we used to, increasing at a rate of about a half-inch per year, which is substantial.  On average, we get an additional 25 inches of snow per year than we did when I was young.</p>
<p>This example shows that with slow-moving trends and noisy data, your instincts can be misleading.</p>
<p>Now, you might suspect that I overestimate the amount of snow when I was young because I enjoyed it, and underestimate it now because I don’t.  But you would be mistaken.</p>
<p>During the Blizzard of 1978, we did not have a snowblower and my brother and I had to shovel.  My sister got a pass for no good reason.  Our driveway was about 60 feet long and three cars wide near the garage.  And we had to shovel Mr. Crocker’s driveway, too, for which we were not allowed to accept payment.  Furthermore, as I recall it was during this excavation that I accidentally hit my brother with a shovel on the head, and it bled a lot because, you know, scalp wounds.</p>
<p>Anyway, the point is that I don’t think I overestimate the amount of snow when I was young because I have fond memories of it.</p>
</div>
<div class="section" id="optimization">
<h2>Optimization<a class="headerlink" href="#optimization" title="Permalink to this headline">¶</a></h2>
<p>The way we computed the likelihood in the previous section was pretty slow.  The problem is that we looped through every possible set of parameters in the prior distribution, and there were more than 60,000 of them.</p>
<p>If we can do more work per iteration, and run the loop fewer times, we expect it to go faster.</p>
<p>In order to do that, I’ll unstack the prior distribution:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">joint3</span> <span class="o">=</span> <span class="n">prior3</span><span class="o">.</span><span class="n">unstack</span><span class="p">()</span>
<span class="n">joint3</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Sigma</th>
      <th>20.0</th>
      <th>20.5</th>
      <th>21.0</th>
      <th>21.5</th>
      <th>22.0</th>
      <th>22.5</th>
      <th>23.0</th>
      <th>23.5</th>
      <th>24.0</th>
      <th>24.5</th>
      <th>...</th>
      <th>30.5</th>
      <th>31.0</th>
      <th>31.5</th>
      <th>32.0</th>
      <th>32.5</th>
      <th>33.0</th>
      <th>33.5</th>
      <th>34.0</th>
      <th>34.5</th>
      <th>35.0</th>
    </tr>
    <tr>
      <th>Slope</th>
      <th>Intercept</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th rowspan="3" valign="top">-0.5</th>
      <th>54.000</th>
      <td>0.000015</td>
      <td>0.000015</td>
      <td>0.000015</td>
      <td>0.000015</td>
      <td>0.000015</td>
      <td>0.000015</td>
      <td>0.000015</td>
      <td>0.000015</td>
      <td>0.000015</td>
      <td>0.000015</td>
      <td>...</td>
      <td>0.000015</td>
      <td>0.000015</td>
      <td>0.000015</td>
      <td>0.000015</td>
      <td>0.000015</td>
      <td>0.000015</td>
      <td>0.000015</td>
      <td>0.000015</td>
      <td>0.000015</td>
      <td>0.000015</td>
    </tr>
    <tr>
      <th>54.525</th>
      <td>0.000015</td>
      <td>0.000015</td>
      <td>0.000015</td>
      <td>0.000015</td>
      <td>0.000015</td>
      <td>0.000015</td>
      <td>0.000015</td>
      <td>0.000015</td>
      <td>0.000015</td>
      <td>0.000015</td>
      <td>...</td>
      <td>0.000015</td>
      <td>0.000015</td>
      <td>0.000015</td>
      <td>0.000015</td>
      <td>0.000015</td>
      <td>0.000015</td>
      <td>0.000015</td>
      <td>0.000015</td>
      <td>0.000015</td>
      <td>0.000015</td>
    </tr>
    <tr>
      <th>55.050</th>
      <td>0.000015</td>
      <td>0.000015</td>
      <td>0.000015</td>
      <td>0.000015</td>
      <td>0.000015</td>
      <td>0.000015</td>
      <td>0.000015</td>
      <td>0.000015</td>
      <td>0.000015</td>
      <td>0.000015</td>
      <td>...</td>
      <td>0.000015</td>
      <td>0.000015</td>
      <td>0.000015</td>
      <td>0.000015</td>
      <td>0.000015</td>
      <td>0.000015</td>
      <td>0.000015</td>
      <td>0.000015</td>
      <td>0.000015</td>
      <td>0.000015</td>
    </tr>
  </tbody>
</table>
<p>3 rows × 31 columns</p>
</div></div></div>
</div>
<p>The result is a <code class="docutils literal notranslate"><span class="pre">DataFrame</span></code> with <code class="docutils literal notranslate"><span class="pre">slope</span></code> and <code class="docutils literal notranslate"><span class="pre">intercept</span></code> down the rows and <code class="docutils literal notranslate"><span class="pre">sigmas</span></code> across the columns.</p>
<p>The following is a version of <code class="docutils literal notranslate"><span class="pre">likelihood_regression</span></code> that takes the joint prior distribution in this form and returns the posterior distribution in the same form.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">utils</span> <span class="kn">import</span> <span class="n">normalize</span>

<span class="k">def</span> <span class="nf">update_optimized</span><span class="p">(</span><span class="n">prior</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Posterior distribution of regression parameters</span>
<span class="sd">    `slope`, `inter`, and `sigma`.</span>
<span class="sd">    </span>
<span class="sd">    prior: Pmf representing the joint prior</span>
<span class="sd">    data: DataFrame with columns `x` and `y`</span>
<span class="sd">    </span>
<span class="sd">    returns: Pmf representing the joint posterior</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">xs</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">]</span>
    <span class="n">ys</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">]</span>
    <span class="n">sigmas</span> <span class="o">=</span> <span class="n">prior</span><span class="o">.</span><span class="n">columns</span>    
    <span class="n">likelihood</span> <span class="o">=</span> <span class="n">prior</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

    <span class="k">for</span> <span class="n">slope</span><span class="p">,</span> <span class="n">inter</span> <span class="ow">in</span> <span class="n">prior</span><span class="o">.</span><span class="n">index</span><span class="p">:</span>
        <span class="n">expected</span> <span class="o">=</span> <span class="n">slope</span> <span class="o">*</span> <span class="n">xs</span> <span class="o">+</span> <span class="n">inter</span>
        <span class="n">resid</span> <span class="o">=</span> <span class="n">ys</span> <span class="o">-</span> <span class="n">expected</span>
        <span class="n">resid_mesh</span><span class="p">,</span> <span class="n">sigma_mesh</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="n">resid</span><span class="p">,</span> <span class="n">sigmas</span><span class="p">)</span>
        <span class="n">densities</span> <span class="o">=</span> <span class="n">norm</span><span class="o">.</span><span class="n">pdf</span><span class="p">(</span><span class="n">resid_mesh</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">sigma_mesh</span><span class="p">)</span>
        <span class="n">likelihood</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">slope</span><span class="p">,</span> <span class="n">inter</span><span class="p">]</span> <span class="o">=</span> <span class="n">densities</span><span class="o">.</span><span class="n">prod</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        
    <span class="n">posterior</span> <span class="o">=</span> <span class="n">prior</span> <span class="o">*</span> <span class="n">likelihood</span>
    <span class="n">normalize</span><span class="p">(</span><span class="n">posterior</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">posterior</span>
</pre></div>
</div>
</div>
</div>
<p>This version loops through all possible pairs of <code class="docutils literal notranslate"><span class="pre">slope</span></code> and <code class="docutils literal notranslate"><span class="pre">inter</span></code>, so the loop runs about 2000 times.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">len</span><span class="p">(</span><span class="n">prior_slope</span><span class="p">)</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">prior_inter</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2091
</pre></div>
</div>
</div>
</div>
<p>Each time through the loop, it uses a grid mesh to compute the likelihood of the data for all values of <code class="docutils literal notranslate"><span class="pre">sigma</span></code>.  The result is an array with one column for each data point and one row for each value of <code class="docutils literal notranslate"><span class="pre">sigma</span></code>.  Taking the product across the columns (<code class="docutils literal notranslate"><span class="pre">axis=1</span></code>) yields the probability of the data for each value of sigma, which we assign as a row in <code class="docutils literal notranslate"><span class="pre">likelihood</span></code>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%</span><span class="k">time</span> posterior_opt = update_optimized(joint3, data)
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>CPU times: user 1.92 s, sys: 9 µs, total: 1.92 s
Wall time: 1.91 s
</pre></div>
</div>
</div>
</div>
<p>We get the same result either way.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">np</span><span class="o">.</span><span class="n">allclose</span><span class="p">(</span><span class="n">posterior</span><span class="p">,</span> <span class="n">posterior_opt</span><span class="o">.</span><span class="n">stack</span><span class="p">())</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>True
</pre></div>
</div>
</div>
</div>
<p>But this version is about 25 times faster than the previous version.</p>
<p>This optimization works because many functions in NumPy and SciPy are written in C, so they run fast compared to Python.  If you can do more work each time you call these functions, and less time running the loop in Python, your code will often run substantially faster.</p>
<p>In this version of the posterior distribution, <code class="docutils literal notranslate"><span class="pre">slope</span></code> and <code class="docutils literal notranslate"><span class="pre">inter</span></code> run down the rows and <code class="docutils literal notranslate"><span class="pre">sigma</span></code> runs across the columns.  So we can use <code class="docutils literal notranslate"><span class="pre">marginal</span></code> to get the posterior joint distribution of <code class="docutils literal notranslate"><span class="pre">slope</span></code> and <code class="docutils literal notranslate"><span class="pre">intercept</span></code>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">utils</span> <span class="kn">import</span> <span class="n">marginal</span>

<span class="n">posterior2</span> <span class="o">=</span> <span class="n">marginal</span><span class="p">(</span><span class="n">posterior_opt</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<span class="n">posterior2</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Slope  Intercept
-0.5   54.000       6.640002e-08
       54.525       8.869737e-08
       55.050       1.169244e-07
dtype: float64
</pre></div>
</div>
</div>
</div>
<p>The result is a <code class="docutils literal notranslate"><span class="pre">Pmf</span></code> with two columns in the index.
To plot it, we have to unstack it.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">joint_posterior</span> <span class="o">=</span> <span class="n">posterior2</span><span class="o">.</span><span class="n">unstack</span><span class="p">()</span><span class="o">.</span><span class="n">transpose</span><span class="p">()</span>
<span class="n">joint_posterior</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th>Slope</th>
      <th>-0.50</th>
      <th>-0.46</th>
      <th>-0.42</th>
      <th>-0.38</th>
      <th>-0.34</th>
      <th>-0.30</th>
      <th>-0.26</th>
      <th>-0.22</th>
      <th>-0.18</th>
      <th>-0.14</th>
      <th>...</th>
      <th>1.14</th>
      <th>1.18</th>
      <th>1.22</th>
      <th>1.26</th>
      <th>1.30</th>
      <th>1.34</th>
      <th>1.38</th>
      <th>1.42</th>
      <th>1.46</th>
      <th>1.50</th>
    </tr>
    <tr>
      <th>Intercept</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>54.000</th>
      <td>6.640002e-08</td>
      <td>1.092361e-07</td>
      <td>1.772653e-07</td>
      <td>2.836386e-07</td>
      <td>4.472961e-07</td>
      <td>6.948632e-07</td>
      <td>0.000001</td>
      <td>0.000002</td>
      <td>0.000002</td>
      <td>0.000003</td>
      <td>...</td>
      <td>0.000004</td>
      <td>0.000003</td>
      <td>0.000002</td>
      <td>0.000001</td>
      <td>8.960879e-07</td>
      <td>5.821444e-07</td>
      <td>3.724348e-07</td>
      <td>2.347649e-07</td>
      <td>1.458767e-07</td>
      <td>8.939151e-08</td>
    </tr>
    <tr>
      <th>54.525</th>
      <td>8.869737e-08</td>
      <td>1.464906e-07</td>
      <td>2.386763e-07</td>
      <td>3.834648e-07</td>
      <td>6.072319e-07</td>
      <td>9.472696e-07</td>
      <td>0.000001</td>
      <td>0.000002</td>
      <td>0.000003</td>
      <td>0.000005</td>
      <td>...</td>
      <td>0.000006</td>
      <td>0.000004</td>
      <td>0.000003</td>
      <td>0.000002</td>
      <td>1.224634e-06</td>
      <td>7.922585e-07</td>
      <td>5.047505e-07</td>
      <td>3.168613e-07</td>
      <td>1.960919e-07</td>
      <td>1.196862e-07</td>
    </tr>
    <tr>
      <th>55.050</th>
      <td>1.169244e-07</td>
      <td>1.938551e-07</td>
      <td>3.170948e-07</td>
      <td>5.115049e-07</td>
      <td>8.132927e-07</td>
      <td>1.273939e-06</td>
      <td>0.000002</td>
      <td>0.000003</td>
      <td>0.000004</td>
      <td>0.000007</td>
      <td>...</td>
      <td>0.000008</td>
      <td>0.000006</td>
      <td>0.000004</td>
      <td>0.000003</td>
      <td>1.650986e-06</td>
      <td>1.063695e-06</td>
      <td>6.749148e-07</td>
      <td>4.219704e-07</td>
      <td>2.600998e-07</td>
      <td>1.581347e-07</td>
    </tr>
  </tbody>
</table>
<p>3 rows × 51 columns</p>
</div></div></div>
</div>
<p>Here’s what it looks like.</p>
<div class="cell tag_hide-input docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">utils</span> <span class="kn">import</span> <span class="n">plot_contour</span>

<span class="n">plot_contour</span><span class="p">(</span><span class="n">joint_posterior</span><span class="p">)</span>
<span class="n">decorate</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="s1">&#39;Posterior joint distribution of slope and intercept&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/chap17_102_0.png" src="_images/chap17_102_0.png" />
</div>
</div>
<p>The ovals in the contour plot are aligned with the axes, which indicates that there is no correlation between <code class="docutils literal notranslate"><span class="pre">slope</span></code> and <code class="docutils literal notranslate"><span class="pre">inter</span></code> in the posterior distribution, which is what we expect since we centered the values.</p>
<p>In this example, the motivating question is about the slope of the line, so we answered it by looking at the posterior distribution of slope.</p>
<p>In the next example, the motivating question is about prediction, so we’ll use the joint posterior distribution to generate predictive distributions.</p>
</div>
<div class="section" id="marathon-world-record">
<h2>Marathon world record<a class="headerlink" href="#marathon-world-record" title="Permalink to this headline">¶</a></h2>
<p>For many running events, if you plot the world record pace over time, the result is a remarkably straight line.  People, <a class="reference external" href="http://allendowney.blogspot.com/2011/04/two-hour-marathon-in-2045.html">including me</a>, have speculated about possible reasons for this phenomenon.</p>
<p>People have also speculated about when, if ever, the world record time for the marathon will be less than two hours.
(Note: In 2019 Eliud Kipchoge ran the marathon distance in under two hours, which is an astonishing achievement that I fully appreciate, but for several reasons it did not count as a world record).</p>
<p>So, as a second example of Bayesian regression, we’ll consider the world record progression for the marathon (for male runners), estimate the parameters of a linear model, and use the model to predict when a runner will break the two-hour barrier.</p>
<p>The following cell downloads a web page from Wikipedia that includes a table of marathon world records, and uses Pandas to put the data in a <code class="docutils literal notranslate"><span class="pre">DataFrame</span></code>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">url</span> <span class="o">=</span> <span class="s1">&#39;https://en.wikipedia.org/wiki/Marathon_world_record_progression#Men&#39;</span>
<span class="n">tables</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_html</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
<span class="nb">len</span><span class="p">(</span><span class="n">tables</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>5
</pre></div>
</div>
</div>
</div>
<p>If that doesn’t work, I have made a copy of this page available.  The following cell downloads and parses it.</p>
<div class="cell tag_hide-cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1">#import os</span>

<span class="c1">#datafile = &#39;Marathon_world_record_progression.html&#39;</span>
<span class="c1">#if not os.path.exists(datafile):</span>
<span class="c1">#    !wget https://github.com/AllenDowney/ThinkBayes2/raw/master/data/Marathon_world_record_progression.html</span>

<span class="c1">#tables = pd.read_html(datafile)</span>
<span class="c1">#len(tables)</span>
</pre></div>
</div>
</div>
</div>
<p>The first table is the one we want.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">table</span> <span class="o">=</span> <span class="n">tables</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">table</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Time</th>
      <th>Name</th>
      <th>Nationality</th>
      <th>Date</th>
      <th>Event/Place</th>
      <th>Source</th>
      <th>Notes</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>2:55:18.4</td>
      <td>Johnny Hayes</td>
      <td>United States</td>
      <td>July 24, 1908</td>
      <td>London, United Kingdom</td>
      <td>IAAF[53]</td>
      <td>Time was officially recorded as 2:55:18 2/5.[5...</td>
    </tr>
    <tr>
      <th>1</th>
      <td>2:52:45.4</td>
      <td>Robert Fowler</td>
      <td>United States</td>
      <td>January 1, 1909</td>
      <td>Yonkers,[nb 5] United States</td>
      <td>IAAF[53]</td>
      <td>Note.[56]</td>
    </tr>
    <tr>
      <th>2</th>
      <td>2:46:52.8</td>
      <td>James Clark</td>
      <td>United States</td>
      <td>February 12, 1909</td>
      <td>New York City, United States</td>
      <td>IAAF[53]</td>
      <td>Note.[56]</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<p>We can use Pandas to parse the dates.
A few of them include notes that cause parsing problems, but the argument <code class="docutils literal notranslate"><span class="pre">errors='coerce'</span></code> tells Pandas to fill invalid dates with <code class="docutils literal notranslate"><span class="pre">NaT</span></code>, which is a version of <code class="docutils literal notranslate"><span class="pre">NaN</span></code> that represents “not a time”.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">table</span><span class="p">[</span><span class="s1">&#39;date&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">table</span><span class="p">[</span><span class="s1">&#39;Date&#39;</span><span class="p">],</span> <span class="n">errors</span><span class="o">=</span><span class="s1">&#39;coerce&#39;</span><span class="p">)</span>
<span class="n">table</span><span class="p">[</span><span class="s1">&#39;date&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>0   1908-07-24
1   1909-01-01
2   1909-02-12
3   1909-05-08
4          NaT
Name: date, dtype: datetime64[ns]
</pre></div>
</div>
</div>
</div>
<p>We can also use Pandas to parse the record times.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">table</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_timedelta</span><span class="p">(</span><span class="n">table</span><span class="p">[</span><span class="s1">&#39;Time&#39;</span><span class="p">])</span>
</pre></div>
</div>
</div>
</div>
<p>And convert the times to paces in miles per hour.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">table</span><span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">26.2</span> <span class="o">/</span> <span class="n">table</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">()</span> <span class="o">*</span> <span class="mi">3600</span>
<span class="n">table</span><span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>0    8.967143
1    9.099504
2    9.419942
3    9.465508
4    9.672854
Name: y, dtype: float64
</pre></div>
</div>
</div>
</div>
<p>The following function plots the results.</p>
<div class="cell tag_hide-input docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">plot_speeds</span><span class="p">(</span><span class="n">df</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Plot marathon world record speed as a function of time.</span>
<span class="sd">    </span>
<span class="sd">    df: DataFrame with date and mph</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="mf">13.1</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;C5&#39;</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;dashed&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;date&#39;</span><span class="p">],</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">],</span> <span class="s1">&#39;o&#39;</span><span class="p">,</span> 
             <span class="n">label</span><span class="o">=</span><span class="s1">&#39;World record speed&#39;</span><span class="p">,</span> 
             <span class="n">color</span><span class="o">=</span><span class="s1">&#39;C1&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
    
    <span class="n">decorate</span><span class="p">(</span><span class="n">xlabel</span><span class="o">=</span><span class="s1">&#39;Date&#39;</span><span class="p">,</span>
             <span class="n">ylabel</span><span class="o">=</span><span class="s1">&#39;Speed (mph)&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Here’s what the results look like.
The dashed line shows the speed required for a two-hour marathon, 13.1 miles per hour.</p>
<div class="cell tag_hide-input docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plot_speeds</span><span class="p">(</span><span class="n">table</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/chap17_119_0.png" src="_images/chap17_119_0.png" />
</div>
</div>
<p>It’s not a perfectly straight line.  In the early years of the marathon, the record speed increased quickly; since about 1970, it has been increasing more slowly.</p>
<p>For our analysis, let’s focus on the recent progression, starting in 1970.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">recent</span> <span class="o">=</span> <span class="n">table</span><span class="p">[</span><span class="s1">&#39;date&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="s1">&#39;1970&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Here’s what it looks like.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">data</span> <span class="o">=</span> <span class="n">table</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">recent</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="n">plot_speeds</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/chap17_123_0.png" src="_images/chap17_123_0.png" />
</div>
</div>
<p>That seems like a straighter line, although it’s possible that the slope is increasing.</p>
<p>To prepare the data for regression, I’ll subtract away the approximate midpoint of the time interval, 1995.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">offset</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="s1">&#39;1995&#39;</span><span class="p">)</span>
<span class="nb">type</span><span class="p">(</span><span class="n">offset</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>pandas._libs.tslibs.timestamps.Timestamp
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">timedelta</span> <span class="o">=</span> <span class="n">table</span><span class="p">[</span><span class="s1">&#39;date&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">offset</span>
</pre></div>
</div>
</div>
</div>
<p>When we subtract two <code class="docutils literal notranslate"><span class="pre">Timestamp</span></code> objects, the result is a “time delta”, which we can convert to seconds and then to years.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">timedelta</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">()</span> <span class="o">/</span> <span class="mi">3600</span> <span class="o">/</span> <span class="mi">24</span> <span class="o">/</span> <span class="mf">365.24</span>
<span class="n">data</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">describe</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>count    18.000000
mean      0.740913
std      15.417918
min     -24.444201
25%     -12.352152
50%       4.264319
75%      13.492498
max      23.707699
Name: x, dtype: float64
</pre></div>
</div>
</div>
</div>
<p>As in the previous example, I’ll use least squares regression to compute point estimates for the parameters, which will help with choosing priors.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">statsmodels.formula.api</span> <span class="k">as</span> <span class="nn">smf</span>

<span class="n">formula</span> <span class="o">=</span> <span class="s1">&#39;y ~ x&#39;</span>
<span class="n">results</span> <span class="o">=</span> <span class="n">smf</span><span class="o">.</span><span class="n">ols</span><span class="p">(</span><span class="n">formula</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">)</span><span class="o">.</span><span class="n">fit</span><span class="p">()</span>
<span class="n">results</span><span class="o">.</span><span class="n">params</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Intercept    12.460507
x             0.015464
dtype: float64
</pre></div>
</div>
</div>
</div>
<p>The estimated intercept is about 12.5 mph, which is the expected world record pace in 1995.  The estimated slope is about 0.015 mph per year, which is rate the world record pace is increasing, according to the model.</p>
<p>Again, we can use the standard deviation of the residuals as a point estimate for <code class="docutils literal notranslate"><span class="pre">sigma</span></code>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">results</span><span class="o">.</span><span class="n">resid</span><span class="o">.</span><span class="n">std</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>0.04139961220193225
</pre></div>
</div>
</div>
</div>
<p>These parameters give us a good idea where we should put the prior distributions.</p>
</div>
<div class="section" id="the-priors">
<h2>The priors<a class="headerlink" href="#the-priors" title="Permalink to this headline">¶</a></h2>
<p>Here are the prior distributions I chose for <code class="docutils literal notranslate"><span class="pre">slope</span></code>, <code class="docutils literal notranslate"><span class="pre">intercept</span></code>, and <code class="docutils literal notranslate"><span class="pre">sigma</span></code>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">qs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mf">0.012</span><span class="p">,</span> <span class="mf">0.018</span><span class="p">,</span> <span class="mi">51</span><span class="p">)</span>
<span class="n">prior_slope</span> <span class="o">=</span> <span class="n">make_uniform</span><span class="p">(</span><span class="n">qs</span><span class="p">,</span> <span class="s1">&#39;Slope&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">qs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mf">12.4</span><span class="p">,</span> <span class="mf">12.5</span><span class="p">,</span> <span class="mi">41</span><span class="p">)</span>
<span class="n">prior_inter</span> <span class="o">=</span> <span class="n">make_uniform</span><span class="p">(</span><span class="n">qs</span><span class="p">,</span> <span class="s1">&#39;Intercept&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">qs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mf">0.01</span><span class="p">,</span> <span class="mf">0.21</span><span class="p">,</span> <span class="mi">31</span><span class="p">)</span>
<span class="n">prior_sigma</span> <span class="o">=</span> <span class="n">make_uniform</span><span class="p">(</span><span class="n">qs</span><span class="p">,</span> <span class="s1">&#39;Sigma&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>And here’s the joint prior distribution.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">joint3</span> <span class="o">=</span> <span class="n">make_joint3</span><span class="p">(</span><span class="n">prior_slope</span><span class="p">,</span> <span class="n">prior_inter</span><span class="p">,</span> <span class="n">prior_sigma</span><span class="p">)</span>
<span class="n">joint3</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Slope  Intercept  Sigma   
0.012  12.4       0.010000    0.000015
                  0.016667    0.000015
                  0.023333    0.000015
                  0.030000    0.000015
                  0.036667    0.000015
dtype: float64
</pre></div>
</div>
</div>
</div>
<p>As in the previous example, I’ll unstack the joint prior so the values of <code class="docutils literal notranslate"><span class="pre">sigma</span></code> run across the columns.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">prior</span> <span class="o">=</span> <span class="n">joint3</span><span class="o">.</span><span class="n">unstack</span><span class="p">()</span>
<span class="n">prior</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Sigma</th>
      <th>0.010000</th>
      <th>0.016667</th>
      <th>0.023333</th>
      <th>0.030000</th>
      <th>0.036667</th>
      <th>0.043333</th>
      <th>0.050000</th>
      <th>0.056667</th>
      <th>0.063333</th>
      <th>0.070000</th>
      <th>...</th>
      <th>0.150000</th>
      <th>0.156667</th>
      <th>0.163333</th>
      <th>0.170000</th>
      <th>0.176667</th>
      <th>0.183333</th>
      <th>0.190000</th>
      <th>0.196667</th>
      <th>0.203333</th>
      <th>0.210000</th>
    </tr>
    <tr>
      <th>Slope</th>
      <th>Intercept</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th rowspan="3" valign="top">0.012</th>
      <th>12.4000</th>
      <td>0.000015</td>
      <td>0.000015</td>
      <td>0.000015</td>
      <td>0.000015</td>
      <td>0.000015</td>
      <td>0.000015</td>
      <td>0.000015</td>
      <td>0.000015</td>
      <td>0.000015</td>
      <td>0.000015</td>
      <td>...</td>
      <td>0.000015</td>
      <td>0.000015</td>
      <td>0.000015</td>
      <td>0.000015</td>
      <td>0.000015</td>
      <td>0.000015</td>
      <td>0.000015</td>
      <td>0.000015</td>
      <td>0.000015</td>
      <td>0.000015</td>
    </tr>
    <tr>
      <th>12.4025</th>
      <td>0.000015</td>
      <td>0.000015</td>
      <td>0.000015</td>
      <td>0.000015</td>
      <td>0.000015</td>
      <td>0.000015</td>
      <td>0.000015</td>
      <td>0.000015</td>
      <td>0.000015</td>
      <td>0.000015</td>
      <td>...</td>
      <td>0.000015</td>
      <td>0.000015</td>
      <td>0.000015</td>
      <td>0.000015</td>
      <td>0.000015</td>
      <td>0.000015</td>
      <td>0.000015</td>
      <td>0.000015</td>
      <td>0.000015</td>
      <td>0.000015</td>
    </tr>
    <tr>
      <th>12.4050</th>
      <td>0.000015</td>
      <td>0.000015</td>
      <td>0.000015</td>
      <td>0.000015</td>
      <td>0.000015</td>
      <td>0.000015</td>
      <td>0.000015</td>
      <td>0.000015</td>
      <td>0.000015</td>
      <td>0.000015</td>
      <td>...</td>
      <td>0.000015</td>
      <td>0.000015</td>
      <td>0.000015</td>
      <td>0.000015</td>
      <td>0.000015</td>
      <td>0.000015</td>
      <td>0.000015</td>
      <td>0.000015</td>
      <td>0.000015</td>
      <td>0.000015</td>
    </tr>
  </tbody>
</table>
<p>3 rows × 31 columns</p>
</div></div></div>
</div>
<p>Representing the prior distribution in this way makes it possible to use the optimized version of the update function.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">posterior</span> <span class="o">=</span> <span class="n">update_optimized</span><span class="p">(</span><span class="n">prior</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>The posterior distribution is unstacked, so we can use <code class="docutils literal notranslate"><span class="pre">marginal</span></code> to extract the posterior distribution of <code class="docutils literal notranslate"><span class="pre">sigma</span></code>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">utils</span> <span class="kn">import</span> <span class="n">marginal</span>

<span class="n">posterior_sigma</span> <span class="o">=</span> <span class="n">marginal</span><span class="p">(</span><span class="n">posterior</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
<span class="n">posterior_sigma</span><span class="o">.</span><span class="n">plot</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/chap17_145_0.png" src="_images/chap17_145_0.png" />
</div>
</div>
<p>We don’t really care what <code class="docutils literal notranslate"><span class="pre">sigma</span></code> is, but we should look at the posterior distribution to make sure the posterior probabilities are near 0 at both extremes.</p>
<p>We can extract the joint distribution of <code class="docutils literal notranslate"><span class="pre">slope</span></code> and <code class="docutils literal notranslate"><span class="pre">inter</span></code> like this.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">posterior_pmf</span> <span class="o">=</span> <span class="n">marginal</span><span class="p">(</span><span class="n">posterior</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<span class="n">posterior_pmf</span><span class="o">.</span><span class="n">shape</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>(2091,)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">posterior_joint</span> <span class="o">=</span> <span class="n">posterior_pmf</span><span class="o">.</span><span class="n">unstack</span><span class="p">()</span><span class="o">.</span><span class="n">transpose</span><span class="p">()</span>
<span class="n">posterior_joint</span><span class="o">.</span><span class="n">shape</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>(41, 51)
</pre></div>
</div>
</div>
</div>
<p>I transposed the result to put <code class="docutils literal notranslate"><span class="pre">slope</span></code> on the <code class="docutils literal notranslate"><span class="pre">x</span></code> axis.  Here’s a contour plot of the joint posterior distribution.</p>
<div class="cell tag_hide-input docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plot_contour</span><span class="p">(</span><span class="n">posterior_joint</span><span class="p">)</span>
<span class="n">decorate</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="s1">&#39;Posterior joint distribution of slope and inter&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/chap17_150_0.png" src="_images/chap17_150_0.png" />
</div>
</div>
<p>The ovals in the contour plot are aligned with the axes, indicating no correlation between the parameters.</p>
<p>Here’s the posterior distribution of <code class="docutils literal notranslate"><span class="pre">inter</span></code>:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">posterior_inter</span> <span class="o">=</span> <span class="n">marginal</span><span class="p">(</span><span class="n">posterior_joint</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">posterior_inter</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;C1&#39;</span><span class="p">)</span>
<span class="n">decorate</span><span class="p">(</span><span class="n">xlabel</span><span class="o">=</span><span class="s1">&#39;intercept&#39;</span><span class="p">,</span>
         <span class="n">ylabel</span><span class="o">=</span><span class="s1">&#39;PDF&#39;</span><span class="p">,</span>
         <span class="n">title</span><span class="o">=</span><span class="s1">&#39;Posterior marginal distribution of intercept&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/chap17_153_0.png" src="_images/chap17_153_0.png" />
</div>
</div>
<p>The posterior mean is about 12.5 mph, which is the world record marathon pace the model predicts for the midpoint of the date range, 1995.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">summarize</span><span class="p">(</span><span class="n">posterior_inter</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>64.201 [58.2   70.275]
</pre></div>
</div>
</div>
</div>
<p>And here’s the posterior distribution of <code class="docutils literal notranslate"><span class="pre">slope</span></code>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">posterior_slope</span> <span class="o">=</span> <span class="n">marginal</span><span class="p">(</span><span class="n">posterior_joint</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell tag_hide-input docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">posterior_slope</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;C4&#39;</span><span class="p">)</span>
<span class="n">decorate</span><span class="p">(</span><span class="n">xlabel</span><span class="o">=</span><span class="s1">&#39;Slope&#39;</span><span class="p">,</span>
         <span class="n">ylabel</span><span class="o">=</span><span class="s1">&#39;PDF&#39;</span><span class="p">,</span>
         <span class="n">title</span><span class="o">=</span><span class="s1">&#39;Posterior marginal distribution of slope&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/chap17_158_0.png" src="_images/chap17_158_0.png" />
</div>
</div>
<p>The posterior mean is about 0.015 mph per year, or 0.15 mph per decade.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">summarize</span><span class="p">(</span><span class="n">posterior_slope</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>0.512 [0.1 0.9]
</pre></div>
</div>
</div>
</div>
<p>That’s interesting, but it doesn’t answer the question we’re interested in: when will there be a two-hour marathon.  To answer that, we have to make predictions.</p>
</div>
<div class="section" id="prediction">
<h2>Prediction<a class="headerlink" href="#prediction" title="Permalink to this headline">¶</a></h2>
<p>To generate predictions, I’ll draw a sample from the posterior distribution of parameters, then use the regression equation to combine the parameters with the data.</p>
<p>The easiest way to sample from the posterior is to stack it and convert to a <code class="docutils literal notranslate"><span class="pre">Pmf</span></code> with a three-column index.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">posterior_pmf</span> <span class="o">=</span> <span class="n">Pmf</span><span class="p">(</span><span class="n">posterior</span><span class="o">.</span><span class="n">stack</span><span class="p">())</span>
<span class="n">posterior_pmf</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Slope  Intercept  Sigma   
0.012  12.4       0.010000    1.262529e-312
                  0.016667    3.343049e-109
                  0.023333     1.094238e-54
                  0.030000     3.900183e-33
                  0.036667     8.441749e-23
dtype: float64
</pre></div>
</div>
</div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">Pmf</span></code> provides <code class="docutils literal notranslate"><span class="pre">sample</span></code>, which we can use to draw a random sample with replacement, using the posterior probabilities as weights.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">sample</span> <span class="o">=</span> <span class="n">posterior_pmf</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="mi">101</span><span class="p">)</span>
<span class="n">sample</span><span class="o">.</span><span class="n">shape</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>(101,)
</pre></div>
</div>
</div>
</div>
<p>The result is an array of tuples.  Looping through the sample, we can use the regression equation to generate predictions for a range of <code class="docutils literal notranslate"><span class="pre">xs</span></code>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">xs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="o">-</span><span class="mi">25</span><span class="p">,</span> <span class="mi">50</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
<span class="n">pred</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">sample</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">xs</span><span class="p">)))</span>

<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">slope</span><span class="p">,</span> <span class="n">inter</span><span class="p">,</span> <span class="n">sigma</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">sample</span><span class="p">):</span>
    <span class="n">epsilon</span> <span class="o">=</span> <span class="n">norm</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">sigma</span><span class="p">)</span><span class="o">.</span><span class="n">rvs</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">xs</span><span class="p">))</span>
    <span class="n">pred</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">inter</span> <span class="o">+</span> <span class="n">slope</span> <span class="o">*</span> <span class="n">xs</span> <span class="o">+</span> <span class="n">epsilon</span>
    
<span class="n">pred</span><span class="o">.</span><span class="n">shape</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>(101, 38)
</pre></div>
</div>
</div>
</div>
<p>Each prediction is an array with the same length as <code class="docutils literal notranslate"><span class="pre">xs</span></code>, which I store as a row in <code class="docutils literal notranslate"><span class="pre">pred</span></code>.  So the result has one row for each sample and one column for each value of <code class="docutils literal notranslate"><span class="pre">x</span></code>.</p>
<p>We can use <code class="docutils literal notranslate"><span class="pre">percentile</span></code> to compute the 5th, 50th, and 95th percentiles in each column.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">low</span><span class="p">,</span> <span class="n">median</span><span class="p">,</span> <span class="n">high</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">pred</span><span class="p">,</span> <span class="p">[</span><span class="mi">5</span><span class="p">,</span> <span class="mi">50</span><span class="p">,</span> <span class="mi">95</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">median</span><span class="o">.</span><span class="n">shape</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>(38,)
</pre></div>
</div>
</div>
</div>
<p>To show the results, I’ll plot the median of the predictions as a line and the 90% credible interval as a shaded area.</p>
<div class="cell tag_hide-input docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">times</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_timedelta</span><span class="p">(</span><span class="n">xs</span><span class="o">*</span><span class="mf">365.24</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="s1">&#39;days&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="n">offset</span>

<span class="n">plt</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span><span class="n">times</span><span class="p">,</span> <span class="n">low</span><span class="p">,</span> <span class="n">high</span><span class="p">,</span> 
                 <span class="n">color</span><span class="o">=</span><span class="s1">&#39;C2&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.1</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">times</span><span class="p">,</span> <span class="n">median</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;C2&#39;</span><span class="p">)</span>

<span class="n">plot_speeds</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/chap17_172_0.png" src="_images/chap17_172_0.png" />
</div>
</div>
<p>The dashed line show the two-hour marathon pace, which is 13.1 miles per hour.
Visually we can estimate that the prediction line hits the target pace between 2030 and 2040.</p>
<p>To make this more precise, we can use interpolation to see when the predictions cross the finish line.  SciPy provides <code class="docutils literal notranslate"><span class="pre">interp1d</span></code>, which does linear interpolation by default.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">scipy.interpolate</span> <span class="kn">import</span> <span class="n">interp1d</span>

<span class="n">future</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">interp1d</span><span class="p">(</span><span class="n">high</span><span class="p">,</span> <span class="n">xs</span><span class="p">)(</span><span class="mf">13.1</span><span class="p">),</span>
                   <span class="n">interp1d</span><span class="p">(</span><span class="n">median</span><span class="p">,</span> <span class="n">xs</span><span class="p">)(</span><span class="mf">13.1</span><span class="p">),</span>
                   <span class="n">interp1d</span><span class="p">(</span><span class="n">low</span><span class="p">,</span> <span class="n">xs</span><span class="p">)(</span><span class="mf">13.1</span><span class="p">)])</span>

<span class="n">pd</span><span class="o">.</span><span class="n">to_timedelta</span><span class="p">(</span><span class="n">future</span><span class="o">*</span><span class="mf">365.24</span><span class="p">,</span> <span class="n">unit</span><span class="o">=</span><span class="s1">&#39;day&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="n">offset</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>DatetimeIndex([&#39;2030-11-12 17:56:10.436409600&#39;,
               &#39;2035-09-18 04:43:12.873532800&#39;,
                  &#39;2042-01-01 20:23:40.839504&#39;],
              dtype=&#39;datetime64[ns]&#39;, freq=None)
</pre></div>
</div>
</div>
</div>
<p>The median prediction is 2035, with 90% credible interval from 2030 to 2042.  So there is about a 5% chance we’ll see a two-hour marathon before 2030.</p>
</div>
<div class="section" id="summary">
<h2>Summary<a class="headerlink" href="#summary" title="Permalink to this headline">¶</a></h2>
<p>This chapter introduces Bayesian regression, which is based on the same model as least squares regression; the difference is that it produces a posterior distribution for the parameters rather than point estimates.</p>
<p>In the first example, we looked at changes in snowfall in Norfolk County, Massachusetts, and concluded that we get more snowfall now than when I was young, contrary to my expectation.</p>
<p>We computed the likelihoods two ways: the first is conceptually simple but slow; the second is optimized to use NumPy more efficiently.</p>
<p>In the second example, we looked at the progression of world record pace for the men’s marathon, computed the joint posterior distribution of the regression parameters, and used it to generate predictions for the next 20 years.</p>
<p>These examples have three parameters, so it takes a little longer to compute the likelihood of the data.
With more than three parameters, it becomes impractical to use grid algorithms.</p>
<p>In the next few chapters, we’ll explore other algorithms that reduce the amount of computation we need to do a Bayesian update, which makes it possible to use models with more parameters.</p>
<p>But first, you might want to work on these exercises.</p>
</div>
<div class="section" id="exercises">
<h2>Exercises<a class="headerlink" href="#exercises" title="Permalink to this headline">¶</a></h2>
<p><strong>Exercise:</strong> I am under the impression that it is warmer around here than it used to be.  In this exercise, you can put my conjecture to the test.</p>
<p>We’ll use the same dataset we used to model snowfall; it also includes daily low and high temperatures in Norfolk County, Massachusetts during my lifetime.</p>
<p>Here’s the data.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s1">&#39;2239075.csv&#39;</span><span class="p">,</span> <span class="n">parse_dates</span><span class="o">=</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
<span class="n">df</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>STATION</th>
      <th>NAME</th>
      <th>DATE</th>
      <th>PRCP</th>
      <th>SNOW</th>
      <th>SNWD</th>
      <th>TMAX</th>
      <th>TMIN</th>
      <th>TOBS</th>
      <th>WESD</th>
      <th>WT01</th>
      <th>WT03</th>
      <th>WT04</th>
      <th>WT05</th>
      <th>WT06</th>
      <th>WT08</th>
      <th>WT09</th>
      <th>WT11</th>
      <th>WT16</th>
      <th>WT18</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>USC00190736</td>
      <td>BLUE HILL COOP, MA US</td>
      <td>1967-05-11</td>
      <td>0.43</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>57</td>
      <td>36.0</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>1</th>
      <td>USC00190736</td>
      <td>BLUE HILL COOP, MA US</td>
      <td>1967-05-12</td>
      <td>0.00</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>58</td>
      <td>39.0</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>2</th>
      <td>USC00190736</td>
      <td>BLUE HILL COOP, MA US</td>
      <td>1967-05-13</td>
      <td>0.00</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>64</td>
      <td>38.0</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<p>Again, I’ll create a column that contains the year part of the dates.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;YEAR&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;DATE&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">year</span>
</pre></div>
</div>
</div>
</div>
<p>This dataset includes <code class="docutils literal notranslate"><span class="pre">TMIN</span></code> and <code class="docutils literal notranslate"><span class="pre">TMAX</span></code>, which are the daily low and high temperatures in degrees F.
I’ll create a new column with the daily midpoint of the low and high temperatures.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;TMID&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;TMIN&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;TMAX&#39;</span><span class="p">])</span> <span class="o">/</span> <span class="mi">2</span>
</pre></div>
</div>
</div>
</div>
<p>Now we can group by year and compute the mean of these daily temperatures.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">tmid</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;YEAR&#39;</span><span class="p">)[</span><span class="s1">&#39;TMID&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
<span class="nb">len</span><span class="p">(</span><span class="n">tmid</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>54
</pre></div>
</div>
</div>
</div>
<p>Again, I’ll drop the first and last years, which are incomplete.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">complete</span> <span class="o">=</span> <span class="n">tmid</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
<span class="nb">len</span><span class="p">(</span><span class="n">complete</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>52
</pre></div>
</div>
</div>
</div>
<p>Here’s what the time series looks like.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">complete</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">style</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>

<span class="n">decorate</span><span class="p">(</span><span class="n">xlabel</span><span class="o">=</span><span class="s1">&#39;Year&#39;</span><span class="p">,</span>
         <span class="n">ylabel</span><span class="o">=</span><span class="s1">&#39;Annual average of daily temperature (deg F)&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/chap17_189_0.png" src="_images/chap17_189_0.png" />
</div>
</div>
<p>As we did with the snow data, I’ll convert the <code class="docutils literal notranslate"><span class="pre">Series</span></code> to a <code class="docutils literal notranslate"><span class="pre">DataFrame</span></code> to prepare it for regression.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">data</span> <span class="o">=</span> <span class="n">complete</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
<span class="n">data</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>YEAR</th>
      <th>TMID</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>1968</td>
      <td>48.071038</td>
    </tr>
    <tr>
      <th>1</th>
      <td>1969</td>
      <td>48.687671</td>
    </tr>
    <tr>
      <th>2</th>
      <td>1970</td>
      <td>48.258904</td>
    </tr>
    <tr>
      <th>3</th>
      <td>1971</td>
      <td>48.804110</td>
    </tr>
    <tr>
      <th>4</th>
      <td>1972</td>
      <td>47.112022</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">offset</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;YEAR&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
<span class="n">offset</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>1993.5
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;YEAR&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">offset</span>
<span class="n">data</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>0.0
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;TMID&#39;</span><span class="p">]</span>
<span class="n">data</span><span class="p">[</span><span class="s1">&#39;y&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">std</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>1.2389114009625752
</pre></div>
</div>
</div>
</div>
<p>Now we can use StatsModels to estimate the parameters.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">statsmodels.formula.api</span> <span class="k">as</span> <span class="nn">smf</span>

<span class="n">formula</span> <span class="o">=</span> <span class="s1">&#39;y ~ x&#39;</span>
<span class="n">results</span> <span class="o">=</span> <span class="n">smf</span><span class="o">.</span><span class="n">ols</span><span class="p">(</span><span class="n">formula</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">)</span><span class="o">.</span><span class="n">fit</span><span class="p">()</span>
<span class="n">results</span><span class="o">.</span><span class="n">params</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Intercept    49.408046
x             0.044252
dtype: float64
</pre></div>
</div>
</div>
</div>
<p>And compute the standard deviation of the parameters.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">results</span><span class="o">.</span><span class="n">resid</span><span class="o">.</span><span class="n">std</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>1.0417057653902058
</pre></div>
</div>
</div>
</div>
<p>According to the least squares regression model, annual average temperature is increasing by about 0.044 degrees F per year.</p>
<p>To quantify the uncertainty of these parameters and generate predictions for the future, we can use Bayesian regression.</p>
<ol class="simple">
<li><p>Choose priors for <code class="docutils literal notranslate"><span class="pre">slope</span></code>, <code class="docutils literal notranslate"><span class="pre">intercept</span></code>, and <code class="docutils literal notranslate"><span class="pre">sigma</span></code> based on these estimates, and use <code class="docutils literal notranslate"><span class="pre">make_joint3</span></code> to make a joint prior distribution.</p></li>
<li><p>Use <code class="docutils literal notranslate"><span class="pre">update_regression</span></code> or <code class="docutils literal notranslate"><span class="pre">update_optimized</span></code> to compute the posterior distribution of the parameters.</p></li>
<li><p>Use <code class="docutils literal notranslate"><span class="pre">pmf_marginal</span></code> to extract the posterior distribution of <code class="docutils literal notranslate"><span class="pre">slope</span></code>.  How confident are we that temperature is increasing?</p></li>
<li><p>Draw a sample of parameters from the posterior distribution and use it to generate predictions up to 2067.</p></li>
<li><p>Plot the median of the predictions and a 90% credible interval along with the observed data.</p></li>
</ol>
<p>Does the model fit the data well?  How much do we expect annual average temperatures to increase over my (expected) lifetime?</p>
<div class="cell tag_hide-cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Solution</span>

<span class="n">prior_slope</span> <span class="o">=</span> <span class="n">make_uniform</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">,</span> <span class="mi">51</span><span class="p">,</span> <span class="s1">&#39;Slope&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell tag_hide-cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Solution</span>

<span class="n">prior_inter</span> <span class="o">=</span> <span class="n">make_uniform</span><span class="p">(</span><span class="mi">48</span><span class="p">,</span> <span class="mi">52</span><span class="p">,</span> <span class="mi">41</span><span class="p">,</span> <span class="s1">&#39;Intercept&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell tag_hide-cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Solution</span>

<span class="n">prior_sigma</span> <span class="o">=</span> <span class="n">make_uniform</span><span class="p">(</span><span class="mf">0.5</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">31</span><span class="p">,</span> <span class="s1">&#39;Sigma&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell tag_hide-cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Solution</span>

<span class="n">joint3</span> <span class="o">=</span> <span class="n">make_joint3</span><span class="p">(</span><span class="n">prior_slope</span><span class="p">,</span> <span class="n">prior_inter</span><span class="p">,</span> <span class="n">prior_sigma</span><span class="p">)</span>
<span class="n">joint3</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Slope  Intercept  Sigma
0.0    48.0       0.50     0.000015
                  0.55     0.000015
                  0.60     0.000015
                  0.65     0.000015
                  0.70     0.000015
dtype: float64
</pre></div>
</div>
</div>
</div>
<div class="cell tag_hide-cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Solution</span>

<span class="n">prior</span> <span class="o">=</span> <span class="n">joint3</span><span class="o">.</span><span class="n">unstack</span><span class="p">()</span>
<span class="n">prior</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Sigma</th>
      <th>0.50</th>
      <th>0.55</th>
      <th>0.60</th>
      <th>0.65</th>
      <th>0.70</th>
      <th>0.75</th>
      <th>0.80</th>
      <th>0.85</th>
      <th>0.90</th>
      <th>0.95</th>
      <th>...</th>
      <th>1.55</th>
      <th>1.60</th>
      <th>1.65</th>
      <th>1.70</th>
      <th>1.75</th>
      <th>1.80</th>
      <th>1.85</th>
      <th>1.90</th>
      <th>1.95</th>
      <th>2.00</th>
    </tr>
    <tr>
      <th>Slope</th>
      <th>Intercept</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th rowspan="5" valign="top">0.0</th>
      <th>48.0</th>
      <td>0.000015</td>
      <td>0.000015</td>
      <td>0.000015</td>
      <td>0.000015</td>
      <td>0.000015</td>
      <td>0.000015</td>
      <td>0.000015</td>
      <td>0.000015</td>
      <td>0.000015</td>
      <td>0.000015</td>
      <td>...</td>
      <td>0.000015</td>
      <td>0.000015</td>
      <td>0.000015</td>
      <td>0.000015</td>
      <td>0.000015</td>
      <td>0.000015</td>
      <td>0.000015</td>
      <td>0.000015</td>
      <td>0.000015</td>
      <td>0.000015</td>
    </tr>
    <tr>
      <th>48.1</th>
      <td>0.000015</td>
      <td>0.000015</td>
      <td>0.000015</td>
      <td>0.000015</td>
      <td>0.000015</td>
      <td>0.000015</td>
      <td>0.000015</td>
      <td>0.000015</td>
      <td>0.000015</td>
      <td>0.000015</td>
      <td>...</td>
      <td>0.000015</td>
      <td>0.000015</td>
      <td>0.000015</td>
      <td>0.000015</td>
      <td>0.000015</td>
      <td>0.000015</td>
      <td>0.000015</td>
      <td>0.000015</td>
      <td>0.000015</td>
      <td>0.000015</td>
    </tr>
    <tr>
      <th>48.2</th>
      <td>0.000015</td>
      <td>0.000015</td>
      <td>0.000015</td>
      <td>0.000015</td>
      <td>0.000015</td>
      <td>0.000015</td>
      <td>0.000015</td>
      <td>0.000015</td>
      <td>0.000015</td>
      <td>0.000015</td>
      <td>...</td>
      <td>0.000015</td>
      <td>0.000015</td>
      <td>0.000015</td>
      <td>0.000015</td>
      <td>0.000015</td>
      <td>0.000015</td>
      <td>0.000015</td>
      <td>0.000015</td>
      <td>0.000015</td>
      <td>0.000015</td>
    </tr>
    <tr>
      <th>48.3</th>
      <td>0.000015</td>
      <td>0.000015</td>
      <td>0.000015</td>
      <td>0.000015</td>
      <td>0.000015</td>
      <td>0.000015</td>
      <td>0.000015</td>
      <td>0.000015</td>
      <td>0.000015</td>
      <td>0.000015</td>
      <td>...</td>
      <td>0.000015</td>
      <td>0.000015</td>
      <td>0.000015</td>
      <td>0.000015</td>
      <td>0.000015</td>
      <td>0.000015</td>
      <td>0.000015</td>
      <td>0.000015</td>
      <td>0.000015</td>
      <td>0.000015</td>
    </tr>
    <tr>
      <th>48.4</th>
      <td>0.000015</td>
      <td>0.000015</td>
      <td>0.000015</td>
      <td>0.000015</td>
      <td>0.000015</td>
      <td>0.000015</td>
      <td>0.000015</td>
      <td>0.000015</td>
      <td>0.000015</td>
      <td>0.000015</td>
      <td>...</td>
      <td>0.000015</td>
      <td>0.000015</td>
      <td>0.000015</td>
      <td>0.000015</td>
      <td>0.000015</td>
      <td>0.000015</td>
      <td>0.000015</td>
      <td>0.000015</td>
      <td>0.000015</td>
      <td>0.000015</td>
    </tr>
  </tbody>
</table>
<p>5 rows × 31 columns</p>
</div></div></div>
</div>
<div class="cell tag_hide-cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Solution</span>

<span class="o">%</span><span class="k">time</span> posterior = update_optimized(prior, data)
<span class="n">posterior</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>CPU times: user 2.38 s, sys: 6 µs, total: 2.38 s
Wall time: 2.38 s
</pre></div>
</div>
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Sigma</th>
      <th>0.50</th>
      <th>0.55</th>
      <th>0.60</th>
      <th>0.65</th>
      <th>0.70</th>
      <th>0.75</th>
      <th>0.80</th>
      <th>0.85</th>
      <th>0.90</th>
      <th>0.95</th>
      <th>...</th>
      <th>1.55</th>
      <th>1.60</th>
      <th>1.65</th>
      <th>1.70</th>
      <th>1.75</th>
      <th>1.80</th>
      <th>1.85</th>
      <th>1.90</th>
      <th>1.95</th>
      <th>2.00</th>
    </tr>
    <tr>
      <th>Slope</th>
      <th>Intercept</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th rowspan="5" valign="top">0.0</th>
      <th>48.0</th>
      <td>5.469482e-133</td>
      <td>8.456993e-108</td>
      <td>5.725427e-89</td>
      <td>1.361579e-74</td>
      <td>2.003735e-63</td>
      <td>1.269228e-54</td>
      <td>1.332824e-47</td>
      <td>6.062184e-42</td>
      <td>2.401400e-37</td>
      <td>1.390022e-33</td>
      <td>...</td>
      <td>2.157676e-17</td>
      <td>4.222518e-17</td>
      <td>7.062026e-17</td>
      <td>1.030877e-16</td>
      <td>1.337189e-16</td>
      <td>1.565114e-16</td>
      <td>1.674872e-16</td>
      <td>1.657382e-16</td>
      <td>1.531524e-16</td>
      <td>1.332827e-16</td>
    </tr>
    <tr>
      <th>48.1</th>
      <td>1.013023e-120</td>
      <td>1.163560e-97</td>
      <td>1.892454e-80</td>
      <td>2.471844e-67</td>
      <td>3.637954e-57</td>
      <td>3.596160e-49</td>
      <td>8.257196e-43</td>
      <td>1.065366e-37</td>
      <td>1.468194e-33</td>
      <td>3.477517e-30</td>
      <td>...</td>
      <td>4.078863e-16</td>
      <td>6.661721e-16</td>
      <td>9.450122e-16</td>
      <td>1.186928e-15</td>
      <td>1.341639e-15</td>
      <td>1.383967e-15</td>
      <td>1.318519e-15</td>
      <td>1.172153e-15</td>
      <td>9.810176e-16</td>
      <td>7.789389e-16</td>
    </tr>
    <tr>
      <th>48.2</th>
      <td>2.344013e-109</td>
      <td>2.869497e-88</td>
      <td>1.475464e-72</td>
      <td>1.310638e-60</td>
      <td>2.285547e-51</td>
      <td>4.042565e-44</td>
      <td>2.270012e-38</td>
      <td>9.115835e-34</td>
      <td>4.723848e-30</td>
      <td>4.889743e-27</td>
      <td>...</td>
      <td>6.210017e-15</td>
      <td>8.577986e-15</td>
      <td>1.044708e-14</td>
      <td>1.141560e-14</td>
      <td>1.135891e-14</td>
      <td>1.042327e-14</td>
      <td>8.916742e-15</td>
      <td>7.177756e-15</td>
      <td>5.480740e-15</td>
      <td>3.997373e-15</td>
    </tr>
    <tr>
      <th>48.3</th>
      <td>6.775916e-99</td>
      <td>1.268432e-79</td>
      <td>2.713423e-65</td>
      <td>2.029684e-54</td>
      <td>4.968659e-46</td>
      <td>1.802993e-39</td>
      <td>2.769232e-34</td>
      <td>3.797716e-30</td>
      <td>7.998382e-27</td>
      <td>3.864312e-24</td>
      <td>...</td>
      <td>7.614602e-14</td>
      <td>9.015050e-14</td>
      <td>9.541170e-14</td>
      <td>9.171287e-14</td>
      <td>8.115153e-14</td>
      <td>6.686217e-14</td>
      <td>5.180136e-14</td>
      <td>3.805706e-14</td>
      <td>2.670613e-14</td>
      <td>1.801307e-14</td>
    </tr>
    <tr>
      <th>48.4</th>
      <td>2.447054e-89</td>
      <td>1.005015e-71</td>
      <td>1.177043e-58</td>
      <td>9.180321e-49</td>
      <td>3.737699e-41</td>
      <td>3.190434e-35</td>
      <td>1.499086e-30</td>
      <td>7.703297e-27</td>
      <td>7.126922e-24</td>
      <td>1.716436e-21</td>
      <td>...</td>
      <td>7.519733e-13</td>
      <td>7.732766e-13</td>
      <td>7.198762e-13</td>
      <td>6.154869e-13</td>
      <td>4.892323e-13</td>
      <td>3.653048e-13</td>
      <td>2.585183e-13</td>
      <td>1.747125e-13</td>
      <td>1.134990e-13</td>
      <td>7.127585e-14</td>
    </tr>
  </tbody>
</table>
<p>5 rows × 31 columns</p>
</div></div></div>
</div>
<div class="cell tag_hide-cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Solution</span>

<span class="n">posterior_sigma</span> <span class="o">=</span> <span class="n">marginal</span><span class="p">(</span><span class="n">posterior</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell tag_hide-cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Solution</span>

<span class="n">posterior_sigma</span><span class="o">.</span><span class="n">plot</span><span class="p">()</span>

<span class="n">decorate</span><span class="p">(</span><span class="n">xlabel</span><span class="o">=</span><span class="s1">&#39;$\sigma$, standard deviation of $\epsilon$&#39;</span><span class="p">,</span>
         <span class="n">ylabel</span><span class="o">=</span><span class="s1">&#39;PDF&#39;</span><span class="p">,</span>
         <span class="n">title</span><span class="o">=</span><span class="s1">&#39;Posterior marginal distribution of $\sigma$&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/chap17_207_0.png" src="_images/chap17_207_0.png" />
</div>
</div>
<div class="cell tag_hide-cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Solution</span>

<span class="n">posterior2</span> <span class="o">=</span> <span class="n">marginal</span><span class="p">(</span><span class="n">posterior</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<span class="n">posterior2</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Slope  Intercept
0.0    48.0         1.160816e-15
       48.1         1.052695e-14
       48.2         9.121251e-14
       48.3         7.591311e-13
       48.4         6.059163e-12
dtype: float64
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">joint_posterior</span> <span class="o">=</span> <span class="n">posterior2</span><span class="o">.</span><span class="n">unstack</span><span class="p">()</span><span class="o">.</span><span class="n">transpose</span><span class="p">()</span>
<span class="n">joint_posterior</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th>Slope</th>
      <th>0.000</th>
      <th>0.002</th>
      <th>0.004</th>
      <th>0.006</th>
      <th>0.008</th>
      <th>0.010</th>
      <th>0.012</th>
      <th>0.014</th>
      <th>0.016</th>
      <th>0.018</th>
      <th>...</th>
      <th>0.082</th>
      <th>0.084</th>
      <th>0.086</th>
      <th>0.088</th>
      <th>0.090</th>
      <th>0.092</th>
      <th>0.094</th>
      <th>0.096</th>
      <th>0.098</th>
      <th>0.100</th>
    </tr>
    <tr>
      <th>Intercept</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>48.0</th>
      <td>1.160816e-15</td>
      <td>1.582183e-15</td>
      <td>2.129943e-15</td>
      <td>2.831465e-15</td>
      <td>3.716188e-15</td>
      <td>4.814340e-15</td>
      <td>6.155121e-15</td>
      <td>7.764342e-15</td>
      <td>9.661593e-15</td>
      <td>1.185707e-14</td>
      <td>...</td>
      <td>3.036299e-15</td>
      <td>2.291371e-15</td>
      <td>1.707482e-15</td>
      <td>1.256646e-15</td>
      <td>9.135882e-16</td>
      <td>6.562184e-16</td>
      <td>4.657827e-16</td>
      <td>3.267587e-16</td>
      <td>2.265936e-16</td>
      <td>1.553486e-16</td>
    </tr>
    <tr>
      <th>48.1</th>
      <td>1.052695e-14</td>
      <td>1.458733e-14</td>
      <td>1.996354e-14</td>
      <td>2.697555e-14</td>
      <td>3.597933e-14</td>
      <td>4.735455e-14</td>
      <td>6.148524e-14</td>
      <td>7.873253e-14</td>
      <td>9.939988e-14</td>
      <td>1.236919e-13</td>
      <td>...</td>
      <td>2.904556e-14</td>
      <td>2.156559e-14</td>
      <td>1.580825e-14</td>
      <td>1.144368e-14</td>
      <td>8.183163e-15</td>
      <td>5.781758e-15</td>
      <td>4.037250e-15</td>
      <td>2.786737e-15</td>
      <td>1.901876e-15</td>
      <td>1.283595e-15</td>
    </tr>
  </tbody>
</table>
<p>2 rows × 51 columns</p>
</div></div></div>
</div>
<div class="cell tag_hide-cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Solution</span>

<span class="n">posterior_slope</span> <span class="o">=</span> <span class="n">marginal</span><span class="p">(</span><span class="n">joint_posterior</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
<span class="n">posterior_inter</span> <span class="o">=</span> <span class="n">marginal</span><span class="p">(</span><span class="n">joint_posterior</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell tag_hide-cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Solution</span>

<span class="n">posterior_inter</span><span class="o">.</span><span class="n">plot</span><span class="p">()</span>
<span class="n">decorate</span><span class="p">(</span><span class="n">xlabel</span><span class="o">=</span><span class="s1">&#39;intercept (inches)&#39;</span><span class="p">,</span>
         <span class="n">ylabel</span><span class="o">=</span><span class="s1">&#39;PDF&#39;</span><span class="p">,</span>
         <span class="n">title</span><span class="o">=</span><span class="s1">&#39;Posterior marginal distribution of intercept&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/chap17_211_0.png" src="_images/chap17_211_0.png" />
</div>
</div>
<div class="cell tag_hide-cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Solution</span>

<span class="n">posterior_inter</span><span class="o">.</span><span class="n">mean</span><span class="p">(),</span> <span class="n">posterior_inter</span><span class="o">.</span><span class="n">credible_interval</span><span class="p">(</span><span class="mf">0.9</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>(49.40804621499325, array([49.2, 49.7]))
</pre></div>
</div>
</div>
</div>
<div class="cell tag_hide-cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Solution</span>

<span class="n">posterior_slope</span><span class="o">.</span><span class="n">plot</span><span class="p">()</span>
<span class="n">decorate</span><span class="p">(</span><span class="n">xlabel</span><span class="o">=</span><span class="s1">&#39;Slope (inches per year)&#39;</span><span class="p">,</span>
         <span class="n">ylabel</span><span class="o">=</span><span class="s1">&#39;PDF&#39;</span><span class="p">,</span>
         <span class="n">title</span><span class="o">=</span><span class="s1">&#39;Posterior marginal distribution of slope&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/chap17_213_0.png" src="_images/chap17_213_0.png" />
</div>
</div>
<div class="cell tag_hide-cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Solution</span>

<span class="n">posterior_slope</span><span class="o">.</span><span class="n">mean</span><span class="p">(),</span> <span class="n">posterior_slope</span><span class="o">.</span><span class="n">credible_interval</span><span class="p">(</span><span class="mf">0.9</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>(0.04425308067803347, array([0.028, 0.06 ]))
</pre></div>
</div>
</div>
</div>
<div class="cell tag_hide-cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Solution</span>

<span class="n">posterior_pmf</span> <span class="o">=</span> <span class="n">Pmf</span><span class="p">(</span><span class="n">posterior</span><span class="o">.</span><span class="n">stack</span><span class="p">())</span>
</pre></div>
</div>
</div>
</div>
<div class="cell tag_hide-cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Solution</span>

<span class="n">sample</span> <span class="o">=</span> <span class="n">posterior_pmf</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="mi">101</span><span class="p">)</span>

<span class="n">years</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">1967</span><span class="p">,</span> <span class="mi">2067</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
<span class="n">xs</span> <span class="o">=</span> <span class="n">years</span> <span class="o">-</span> <span class="n">offset</span>

<span class="n">pred</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">sample</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">xs</span><span class="p">)))</span>
<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">slope</span><span class="p">,</span> <span class="n">inter</span><span class="p">,</span> <span class="n">sigma</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">sample</span><span class="p">):</span>
    <span class="n">pred</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">inter</span> <span class="o">+</span> <span class="n">slope</span> <span class="o">*</span> <span class="n">xs</span> <span class="o">+</span> <span class="n">norm</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">sigma</span><span class="p">)</span><span class="o">.</span><span class="n">rvs</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">xs</span><span class="p">))</span>
    
<span class="n">pred</span><span class="o">.</span><span class="n">shape</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>(101, 50)
</pre></div>
</div>
</div>
</div>
<div class="cell tag_hide-cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Solution</span>

<span class="n">low</span><span class="p">,</span> <span class="n">median</span><span class="p">,</span> <span class="n">high</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">pred</span><span class="p">,</span> <span class="p">[</span><span class="mi">5</span><span class="p">,</span> <span class="mi">50</span><span class="p">,</span> <span class="mi">95</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">median</span><span class="o">.</span><span class="n">shape</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>(50,)
</pre></div>
</div>
</div>
</div>
<div class="cell tag_hide-cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Solution</span>

<span class="n">plt</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span><span class="n">years</span><span class="p">,</span> <span class="n">low</span><span class="p">,</span> <span class="n">high</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.1</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">years</span><span class="p">,</span> <span class="n">median</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;C0&#39;</span><span class="p">)</span>

<span class="n">complete</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">style</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>

<span class="n">decorate</span><span class="p">(</span><span class="n">xlabel</span><span class="o">=</span><span class="s1">&#39;Year&#39;</span><span class="p">,</span>
         <span class="n">ylabel</span><span class="o">=</span><span class="s1">&#39;Annual average of daily temperature (deg F)&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/chap17_218_0.png" src="_images/chap17_218_0.png" />
</div>
</div>
<div class="cell tag_hide-cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Solution</span>

<span class="c1"># median increase over my lifetime in degrees F</span>

<span class="n">median</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">median</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>4.104171770703772
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="gss-data">
<h2>GSS data<a class="headerlink" href="#gss-data" title="Permalink to this headline">¶</a></h2>
<p>Another example using data from the <a class="reference external" href="https://gss.norc.org/">General Social Survey</a> …</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Load the data file</span>

<span class="c1"># TODO: Update this to point to the ThinkBayes2 repo</span>

<span class="kn">import</span> <span class="nn">os</span>

<span class="n">datafile</span> <span class="o">=</span> <span class="s1">&#39;gss_eda.hdf5&#39;</span>
<span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">datafile</span><span class="p">):</span>
    <span class="o">!</span>wget https://github.com/AllenDowney/PoliticalAlignmentCaseStudy/raw/master/gss_eda.hdf5
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">gss</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_hdf</span><span class="p">(</span><span class="n">datafile</span><span class="p">,</span> <span class="s1">&#39;gss&#39;</span><span class="p">)</span>
<span class="n">gss</span><span class="o">.</span><span class="n">shape</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>(64814, 169)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">gss</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;year&#39;</span><span class="p">)[</span><span class="s1">&#39;realrinc&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>year
1972              NaN
1973              NaN
1974     96450.000000
1975     75863.000000
1976     81652.000000
1977    201640.000000
1978    135131.000000
1980    139297.000000
1982     97992.000000
1983     81266.000000
1984     87058.000000
1985     96036.000000
1986    101376.000000
1987     92594.000000
1988     83666.000000
1989     80690.000000
1990    103206.000000
1991    111284.000000
1993    123611.000000
1994     97684.000000
1996     87419.000000
1998    150054.000000
2000    134018.000000
2002    234366.656250
2004    134008.437500
2006    159292.265625
2008    480144.468750
2010    109525.156250
2012    341672.375000
2014    132148.078125
2016    164382.031250
2018    151050.718750
Name: realrinc, dtype: float32
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">gss</span><span class="p">[</span><span class="s1">&#39;rincome&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">value_counts</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>12.0    14957
9.0      4876
11.0     3838
10.0     3838
2.0      1865
8.0      1745
1.0      1306
3.0      1243
5.0      1091
4.0      1055
6.0       993
7.0       981
Name: rincome, dtype: int64
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">valid</span> <span class="o">=</span> <span class="n">gss</span><span class="o">.</span><span class="n">dropna</span><span class="p">(</span><span class="n">subset</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;rincome&#39;</span><span class="p">,</span> <span class="s1">&#39;realinc&#39;</span><span class="p">])</span>
<span class="n">valid</span><span class="o">.</span><span class="n">shape</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>(36916, 169)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">group</span> <span class="ow">in</span> <span class="n">valid</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;year&#39;</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">name</span> <span class="o">==</span> <span class="mi">2000</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">group</span><span class="p">[</span><span class="s1">&#39;income&#39;</span><span class="p">],</span> <span class="n">group</span><span class="p">[</span><span class="s1">&#39;realinc&#39;</span><span class="p">],</span> <span class="s1">&#39;.&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>2000
</pre></div>
</div>
<img alt="_images/chap17_226_1.png" src="_images/chap17_226_1.png" />
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">valid</span> <span class="o">=</span> <span class="n">gss</span><span class="o">.</span><span class="n">dropna</span><span class="p">(</span><span class="n">subset</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;realinc&#39;</span><span class="p">,</span> <span class="s1">&#39;polviews&#39;</span><span class="p">])</span>
<span class="n">valid</span><span class="o">.</span><span class="n">shape</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>(50191, 169)
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">valid</span><span class="p">[</span><span class="s1">&#39;realinc&#39;</span><span class="p">],</span> <span class="n">valid</span><span class="p">[</span><span class="s1">&#39;polviews&#39;</span><span class="p">],</span> <span class="s1">&#39;,&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>[&lt;matplotlib.lines.Line2D at 0x7fb99f8720d0&gt;]
</pre></div>
</div>
<img alt="_images/chap17_228_1.png" src="_images/chap17_228_1.png" />
</div>
</div>
</div>
</div>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            kernelName: "python3",
            path: "./."
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

              </div>
              
        </div>
    </div>
    
    
    <div class='prev-next-bottom'>
        
    <a class='left-prev' id="prev-link" href="chap16.html" title="previous page">Logistic regression</a>
    <a class='right-next' id="next-link" href="chap18.html" title="next page">Conjugate Priors</a>

    </div>
    <footer class="footer mt-5 mt-md-0">
    <div class="container">
      <p>
        
          By Allen B. Downey<br/>
        
            &copy; Copyright 2020.<br/>
      </p>
    </div>
  </footer>
</main>


      </div>
    </div>

    
  <script src="_static/js/index.3da636dd464baa7582d2.js"></script>


    
  </body>
</html>