

<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta charset="utf-8" />
    <title>Think Bayes &#8212; Think Bayes</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.11.2/css/all.min.css" integrity="sha384-KA6wR/X5RY4zFAHpv/CnoG2UW1uogYfdnP67Uv7eULvTveboZJg0qUpmJZb5VqzN" crossorigin="anonymous">
    <link href="_static/css/index.css" rel="stylesheet">
    <link rel="stylesheet" href="_static/sphinx-book-theme.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    <link rel="stylesheet" type="text/css" href="_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="_static/mystnb.css" />
    <link rel="stylesheet" type="text/css" href="_static/sphinx-thebe.css" />
    <link rel="stylesheet" type="text/css" href="_static/jupyter-sphinx.css" />
    <script id="documentation_options" data-url_root="./" src="_static/documentation_options.js"></script>
    <script src="_static/sphinx-book-theme.js"></script>
    <script src="_static/jquery.js"></script>
    <script src="_static/underscore.js"></script>
    <script src="_static/doctools.js"></script>
    <script src="_static/language_data.js"></script>
    <script src="_static/togglebutton.js"></script>
    <script src="_static/clipboard.min.js"></script>
    <script src="_static/copybutton.js"></script>
    <script src="_static/mystnb.js"></script>
    <script src="_static/sphinx-book-theme.js"></script>
    <script >var togglebuttonSelector = '.toggle, .admonition.dropdown, .tag_hide_input div.cell_input, .tag_hide-input div.cell_input, .tag_hide_output div.cell_output, .tag_hide-output div.cell_output, .tag_hide_cell.cell, .tag_hide-cell.cell';</script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <script src="https://unpkg.com/@jupyter-widgets/html-manager@^0.18.0/dist/embed-amd.js"></script>
    <script async="async" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <script async="async" src="https://unpkg.com/thebelab@latest/lib/index.js"></script>
    <script >
        const thebe_selector = ".thebe"
        const thebe_selector_input = "pre"
        const thebe_selector_output = ".output"
    </script>
    <script async="async" src="_static/sphinx-thebe.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />

    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="docsearch:language" content="en">



  </head>
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="80">
    

    <div class="container-xl">
      <div class="row">
          
<div class="col-12 col-md-3 bd-sidebar site-navigation show" id="site-navigation">
    
        <div class="navbar-brand-box">
<a class="navbar-brand text-wrap" href="index.html">
  
  
  <h1 class="site-logo" id="site-title">Think Bayes</h1>
  
</a>
</div>

<form class="bd-search d-flex align-items-center" action="search.html" method="get">
  <i class="icon fas fa-search"></i>
  <input type="search" class="form-control" name="q" id="search-input" placeholder="Search this book..." aria-label="Search this book..." autocomplete="off" >
</form>

<nav class="bd-links" id="bd-docs-nav" aria-label="Main navigation">
  <ul class="nav sidenav_l1">
 <li class="toctree-l1">
  <a class="reference internal" href="chap00.html">
   Probability
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="chap01.html">
   Bayes’s Theorem
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="chap02.html">
   Distributions
  </a>
 </li>
</ul>

</nav>

 <!-- To handle the deprecated key -->

</div>


          


          
<main class="col py-md-3 pl-md-4 bd-content overflow-auto" role="main">
    
    <div class="row topbar fixed-top container-xl">
    <div class="col-12 col-md-3 bd-topbar-whitespace site-navigation show">
    </div>
    <div class="col pl-2 topbar-main">
        
        <button id="navbar-toggler" class="navbar-toggler ml-0" type="button" data-toggle="collapse"
            data-toggle="tooltip" data-placement="bottom" data-target=".site-navigation" aria-controls="navbar-menu"
            aria-expanded="true" aria-label="Toggle navigation" aria-controls="site-navigation"
            title="Toggle navigation" data-toggle="tooltip" data-placement="left">
            <i class="fas fa-bars"></i>
            <i class="fas fa-arrow-left"></i>
            <i class="fas fa-arrow-up"></i>
        </button>
        
        <div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn" aria-label="Download this page"><i
            class="fas fa-download"></i></button>

    
    <div class="dropdown-buttons">
        <!-- ipynb file if we had a myst markdown file -->
        
        <!-- Download raw file -->
        <a class="dropdown-buttons" href="_sources/chap12.ipynb"><button type="button"
                class="btn btn-secondary topbarbtn" title="Download source file" data-toggle="tooltip"
                data-placement="left">.ipynb</button></a>
        <!-- Download PDF via print -->
        <button type="button" id="download-print" class="btn btn-secondary topbarbtn" title="Print to PDF"
            onClick="window.print()" data-toggle="tooltip" data-placement="left">.pdf</button>
    </div>
    
</div>
        <!-- Source interaction buttons -->

<div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn"
        aria-label="Connect with source repository"><i class="fab fa-github"></i></button>
    <div class="dropdown-buttons sourcebuttons">
        <a class="repository-button"
            href="https://github.com/AllenDowney/ThinkBayes2"><button type="button" class="btn btn-secondary topbarbtn"
                data-toggle="tooltip" data-placement="left" title="Source repository"><i
                    class="fab fa-github"></i>repository</button></a>
        
        
    </div>
</div>


        <!-- Full screen (wrap in <a> to have style consistency -->
        <a class="full-screen-button"><button type="button" class="btn btn-secondary topbarbtn" data-toggle="tooltip"
                data-placement="bottom" onclick="toggleFullScreen()" title="Fullscreen mode"><i
                    class="fas fa-expand"></i></button></a>

        <!-- Launch buttons -->

    </div>

    <!-- Table of contents -->
    <div class="d-none d-md-block col-md-2 bd-toc show">
        <div class="tocsection onthispage pt-5 pb-3">
            <i class="fas fa-list"></i> Contents
        </div>
        <nav id="bd-toc-nav">
            <ul class="nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#introduction">
   Introduction
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#the-weibull-distribution">
   The Weibull distribution
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#marginal-distributions">
   Marginal distributions
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#incomplete-data">
   Incomplete data
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#using-incomplete-data">
   Using incomplete data
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#lightbulbs">
   Lightbulbs
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#posterior-means">
   Posterior means
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#summary">
   Summary
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#exercises">
   Exercises
  </a>
 </li>
</ul>

        </nav>
    </div>
</div>
    <div id="main-content" class="row">
        <div class="col-12 col-md-9 pl-md-3 pr-md-0">
        
              <div>
                
  <div class="section" id="think-bayes">
<h1>Think Bayes<a class="headerlink" href="#think-bayes" title="Permalink to this headline">¶</a></h1>
<p>Second Edition</p>
<p>Copyright 2020 Allen B. Downey</p>
<p>License: <a class="reference external" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">Attribution-NonCommercial-ShareAlike 4.0 International (CC BY-NC-SA 4.0)</a></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span># If we&#39;re running on Colab, install empiricaldist
# https://pypi.org/project/empiricaldist/

import sys
IN_COLAB = &#39;google.colab&#39; in sys.modules

if IN_COLAB:
    !pip install empiricaldist
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span># Get utils.py and create directories

import os

if not os.path.exists(&#39;utils.py&#39;):
    !wget https://github.com/AllenDowney/ThinkBayes2/raw/master/code/soln/utils.py
        
if not os.path.exists(&#39;figs&#39;):
    !mkdir figs
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>

<span class="kn">from</span> <span class="nn">empiricaldist</span> <span class="kn">import</span> <span class="n">Pmf</span><span class="p">,</span> <span class="n">Cdf</span>
<span class="kn">from</span> <span class="nn">utils</span> <span class="kn">import</span> <span class="n">decorate</span><span class="p">,</span> <span class="n">savefig</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="introduction">
<h2>Introduction<a class="headerlink" href="#introduction" title="Permalink to this headline">¶</a></h2>
<p>This chapter introduces “survival analysis”, which is a set of statistical methods used to answer questions about the time until an event.
In the context of medicine it is literally about survival, but more generally it applied to the time until any kind of event, or even more generally it can be about space or other dimensions.</p>
<p>Survival analysis is challenging because the data we have are often incomplete.  But as we’ll see, Bayesian methods are particularly good at working with incomplete data.</p>
<p>As examples, we’ll consider two applications that are a little less serious than life and death: the time until lightbulbs fail and the time until dogs in a shelter are adopted.</p>
<p>To describe these “survival times”, we’ll use the Weibull distribution.</p>
</div>
<div class="section" id="the-weibull-distribution">
<h2>The Weibull distribution<a class="headerlink" href="#the-weibull-distribution" title="Permalink to this headline">¶</a></h2>
<p>The <span class="xref myst">Weibull distribution</span> is often used in survival analysis because it models the distribution of lifetimes for manufactured products, at least over some parts of the range.</p>
<p>SciPy provides implementations for several versions of the Weibull distribution; the one I’ll use is called <code class="docutils literal notranslate"><span class="pre">weibull_min</span></code>.</p>
<p>To make this implementation easier to use, I’ll wrap it in a function that takes two parameters: <span class="math notranslate nohighlight">\(\lambda\)</span>, which mostly affects the location or “central tendency” of the distribution, and <span class="math notranslate nohighlight">\(k\)</span>, which affects the shape.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">scipy.stats</span> <span class="kn">import</span> <span class="n">weibull_min</span>

<span class="k">def</span> <span class="nf">weibull_dist</span><span class="p">(</span><span class="n">lam</span><span class="p">,</span> <span class="n">k</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Makes a weibull object.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">weibull_min</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="n">lam</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Here’s an example.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">lam</span> <span class="o">=</span> <span class="mi">3</span>
<span class="n">k</span> <span class="o">=</span> <span class="mf">0.8</span>
<span class="n">actual_dist</span> <span class="o">=</span> <span class="n">weibull_dist</span><span class="p">(</span><span class="n">lam</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>And here’s what the CDF looks like with those parameters.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">qs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">101</span><span class="p">)</span>
<span class="n">ps</span> <span class="o">=</span> <span class="n">actual_dist</span><span class="o">.</span><span class="n">cdf</span><span class="p">(</span><span class="n">qs</span><span class="p">)</span>
<span class="n">cdf</span> <span class="o">=</span> <span class="n">Cdf</span><span class="p">(</span><span class="n">ps</span><span class="p">,</span> <span class="n">qs</span><span class="p">)</span>
<span class="n">cdf</span><span class="o">.</span><span class="n">plot</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/chap12_10_0.png" src="_images/chap12_10_0.png" />
</div>
</div>
<p>Given the parameters, we can generate a random dataset, like this.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">17</span><span class="p">)</span>
<span class="n">data</span> <span class="o">=</span> <span class="n">actual_dist</span><span class="o">.</span><span class="n">rvs</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
<span class="n">data</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-none notranslate"><div class="highlight"><pre><span></span>array([0.80497283, 2.11577082, 0.43308797, 0.10862644, 5.17334866,
       3.25745053, 3.05555883, 2.47401062, 0.05340806, 1.08386395])
</pre></div>
</div>
</div>
</div>
<p>Now let’s see if we can go the other way: given the data, we’ll estimate the parameters.</p>
<p>Here’s a uniform prior distribution for <span class="math notranslate nohighlight">\(\lambda\)</span>:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">lams</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mf">0.1</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">101</span><span class="p">)</span>
<span class="n">prior_lam</span> <span class="o">=</span> <span class="n">Pmf</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">lams</span><span class="p">)</span>
<span class="n">prior_lam</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;lambda&#39;</span>
<span class="n">prior_lam</span><span class="o">.</span><span class="n">normalize</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-none notranslate"><div class="highlight"><pre><span></span>101
</pre></div>
</div>
</div>
</div>
<p>And a uniform prior for <span class="math notranslate nohighlight">\(k\)</span>:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">ks</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mf">0.1</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">101</span><span class="p">)</span>
<span class="n">prior_k</span> <span class="o">=</span> <span class="n">Pmf</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">ks</span><span class="p">)</span>
<span class="n">prior_k</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;k&#39;</span>
<span class="n">prior_k</span><span class="o">.</span><span class="n">normalize</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-none notranslate"><div class="highlight"><pre><span></span>101
</pre></div>
</div>
</div>
</div>
<p>As we’ve see before, I’ll use <code class="docutils literal notranslate"><span class="pre">make_joint</span></code> to make a joint prior distribution for the two parameters.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">make_joint</span><span class="p">(</span><span class="n">s1</span><span class="p">,</span> <span class="n">s2</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Compute the outer product of two Series.</span>
<span class="sd">    </span>
<span class="sd">    First Series across the columns;</span>
<span class="sd">    second goes goes down the rows.</span>
<span class="sd">    </span>
<span class="sd">    s1: Series</span>
<span class="sd">    s2: Series</span>
<span class="sd">    </span>
<span class="sd">    return: DataFrame</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">X</span><span class="p">,</span> <span class="n">Y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="n">s1</span><span class="p">,</span> <span class="n">s2</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">X</span><span class="o">*</span><span class="n">Y</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="n">s1</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">s2</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">prior</span> <span class="o">=</span> <span class="n">make_joint</span><span class="p">(</span><span class="n">prior_lam</span><span class="p">,</span> <span class="n">prior_k</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Now I’ll use <code class="docutils literal notranslate"><span class="pre">meshgrid</span></code> to make a 3-D mesh with <span class="math notranslate nohighlight">\(\lambda\)</span> on the first axis (numbered <code class="docutils literal notranslate"><span class="pre">axis=0</span></code>), <span class="math notranslate nohighlight">\(k\)</span> on the second axis (<code class="docutils literal notranslate"><span class="pre">axis=1</span></code>), and the data on the third axis (<code class="docutils literal notranslate"><span class="pre">axis=2</span></code>).</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">lam_mesh</span><span class="p">,</span> <span class="n">k_mesh</span><span class="p">,</span> <span class="n">data_mesh</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="n">prior</span><span class="o">.</span><span class="n">columns</span><span class="p">,</span> <span class="n">prior</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Now we can use <code class="docutils literal notranslate"><span class="pre">weibull_dist</span></code> to compute the PDF of the Weibull distribution for each pair of parameters and each data point.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">densities</span> <span class="o">=</span> <span class="n">weibull_dist</span><span class="p">(</span><span class="n">lam_mesh</span><span class="p">,</span> <span class="n">k_mesh</span><span class="p">)</span><span class="o">.</span><span class="n">pdf</span><span class="p">(</span><span class="n">data_mesh</span><span class="p">)</span>
<span class="n">densities</span><span class="o">.</span><span class="n">shape</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-none notranslate"><div class="highlight"><pre><span></span>(101, 101, 10)
</pre></div>
</div>
</div>
</div>
<p>The likelihood of the data is the product of the probability densities along <code class="docutils literal notranslate"><span class="pre">axis=2</span></code>, which is the axis of the dataset.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">likelihood</span> <span class="o">=</span> <span class="n">densities</span><span class="o">.</span><span class="n">prod</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
<span class="n">likelihood</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-none notranslate"><div class="highlight"><pre><span></span>2.1579134255822728e-05
</pre></div>
</div>
</div>
</div>
<p>Now we can compute the posterior distribution in the usual way.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">utils</span> <span class="kn">import</span> <span class="n">normalize</span>

<span class="n">posterior</span> <span class="o">=</span> <span class="n">prior</span> <span class="o">*</span> <span class="n">likelihood</span>
<span class="n">normalize</span><span class="p">(</span><span class="n">posterior</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>The following function encapsulates these steps.<br />
It takes a joint prior distribution and the data, and returns a joint posterior distribution.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">utils</span> <span class="kn">import</span> <span class="n">normalize</span>

<span class="k">def</span> <span class="nf">update_weibull</span><span class="p">(</span><span class="n">prior</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Update the prior based on data.</span>
<span class="sd">    </span>
<span class="sd">    prior: joint distribution of mu and sigma</span>
<span class="sd">    data: sequence of observations</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">lam_mesh</span><span class="p">,</span> <span class="n">k_mesh</span><span class="p">,</span> <span class="n">data_mesh</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="n">prior</span><span class="o">.</span><span class="n">columns</span><span class="p">,</span> <span class="n">prior</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
    <span class="n">densities</span> <span class="o">=</span> <span class="n">weibull_dist</span><span class="p">(</span><span class="n">lam_mesh</span><span class="p">,</span> <span class="n">k_mesh</span><span class="p">)</span><span class="o">.</span><span class="n">pdf</span><span class="p">(</span><span class="n">data_mesh</span><span class="p">)</span>
    <span class="n">likelihood</span> <span class="o">=</span> <span class="n">densities</span><span class="o">.</span><span class="n">prod</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>

    <span class="n">posterior</span> <span class="o">=</span> <span class="n">prior</span> <span class="o">*</span> <span class="n">likelihood</span>
    <span class="n">normalize</span><span class="p">(</span><span class="n">posterior</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">posterior</span>
</pre></div>
</div>
</div>
</div>
<p>Here’s how we use it.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">posterior</span> <span class="o">=</span> <span class="n">update_weibull</span><span class="p">(</span><span class="n">prior</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>I’ll use <code class="docutils literal notranslate"><span class="pre">plot_contour</span></code> to display the results.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">plot_contour</span><span class="p">(</span><span class="n">joint</span><span class="p">,</span> <span class="o">**</span><span class="n">options</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Plot a joint distribution.</span>
<span class="sd">    </span>
<span class="sd">    joint: DataFrame representing a joint PMF</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">cs</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">contour</span><span class="p">(</span><span class="n">joint</span><span class="o">.</span><span class="n">columns</span><span class="p">,</span> <span class="n">joint</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">joint</span><span class="p">,</span> <span class="o">**</span><span class="n">options</span><span class="p">)</span>
    <span class="n">decorate</span><span class="p">(</span><span class="n">xlabel</span><span class="o">=</span><span class="n">joint</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> 
             <span class="n">ylabel</span><span class="o">=</span><span class="n">joint</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">cs</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">plot_contour</span><span class="p">(</span><span class="n">posterior</span><span class="p">)</span>
<span class="n">decorate</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="s1">&#39;Posterior joint distribution of Weibull parameters&#39;</span><span class="p">)</span>
<span class="n">savefig</span><span class="p">(</span><span class="s1">&#39;fig12-01&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/chap12_34_0.png" src="_images/chap12_34_0.png" />
</div>
</div>
<p>The blob in the lower left contains almost all of the probability density; the jaggy line in the upper left is an irrelevent boundary between regions of very low probability.</p>
<p>It looks like the range of likely values for <span class="math notranslate nohighlight">\(\lambda\)</span> is about 1 to 4, which contains the actual value we used to generate the data, 3.
And the range for <span class="math notranslate nohighlight">\(k\)</span> is about 0.5 to 1.5, which contains the actual value, 0.8.</p>
</div>
<div class="section" id="marginal-distributions">
<h2>Marginal distributions<a class="headerlink" href="#marginal-distributions" title="Permalink to this headline">¶</a></h2>
<p>To be more precise about these ranges, we can extract the marginal distributions:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">utils</span> <span class="kn">import</span> <span class="n">marginal</span>

<span class="n">posterior_lam</span> <span class="o">=</span> <span class="n">marginal</span><span class="p">(</span><span class="n">posterior</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
<span class="n">posterior_k</span> <span class="o">=</span> <span class="n">marginal</span><span class="p">(</span><span class="n">posterior</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>And compute the posterior means and 90% credible intervals.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">posterior_lam</span><span class="o">.</span><span class="n">plot</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">)</span>
<span class="n">decorate</span><span class="p">(</span><span class="n">xlabel</span><span class="o">=</span><span class="s1">&#39;lam&#39;</span><span class="p">,</span>
         <span class="n">ylabel</span><span class="o">=</span><span class="s1">&#39;PDF&#39;</span><span class="p">,</span> 
         <span class="n">title</span><span class="o">=</span><span class="s1">&#39;Posterior marginal distribution of lam&#39;</span><span class="p">)</span>

<span class="n">posterior_lam</span><span class="o">.</span><span class="n">mean</span><span class="p">(),</span> <span class="n">posterior_lam</span><span class="o">.</span><span class="n">credible_interval</span><span class="p">(</span><span class="mf">0.9</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-none notranslate"><div class="highlight"><pre><span></span>(2.406081938305909, array([1.189, 4.357]))
</pre></div>
</div>
<img alt="_images/chap12_39_1.png" src="_images/chap12_39_1.png" />
</div>
</div>
<p>The vertical gray line show the actual value of <span class="math notranslate nohighlight">\(\lambda\)</span>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">posterior_k</span><span class="o">.</span><span class="n">plot</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="mf">0.8</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">)</span>
<span class="n">decorate</span><span class="p">(</span><span class="n">xlabel</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span>
         <span class="n">ylabel</span><span class="o">=</span><span class="s1">&#39;PDF&#39;</span><span class="p">,</span> 
         <span class="n">title</span><span class="o">=</span><span class="s1">&#39;Posterior marginal distribution of k&#39;</span><span class="p">)</span>

<span class="n">posterior_k</span><span class="o">.</span><span class="n">mean</span><span class="p">(),</span> <span class="n">posterior_k</span><span class="o">.</span><span class="n">credible_interval</span><span class="p">(</span><span class="mf">0.9</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-none notranslate"><div class="highlight"><pre><span></span>(0.9640523544883197, array([0.59 , 1.423]))
</pre></div>
</div>
<img alt="_images/chap12_41_1.png" src="_images/chap12_41_1.png" />
</div>
</div>
<p>The posterior distributions are wide, which means that with only 10 data points we can’t estimated the parameters precisely.
But for both parameters, the actual value falls in the credible interval.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>

<span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<span class="n">posterior_lam</span><span class="o">.</span><span class="n">plot</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">)</span>
<span class="n">decorate</span><span class="p">(</span><span class="n">xlabel</span><span class="o">=</span><span class="s1">&#39;lam&#39;</span><span class="p">,</span>
         <span class="n">ylabel</span><span class="o">=</span><span class="s1">&#39;PDF&#39;</span><span class="p">,</span> 
         <span class="n">title</span><span class="o">=</span><span class="s1">&#39;Posterior marginal distribution of lam&#39;</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
<span class="n">posterior_k</span><span class="o">.</span><span class="n">plot</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="mf">0.8</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">)</span>
<span class="n">decorate</span><span class="p">(</span><span class="n">xlabel</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span>
         <span class="n">ylabel</span><span class="o">=</span><span class="s1">&#39;PDF&#39;</span><span class="p">,</span> 
         <span class="n">title</span><span class="o">=</span><span class="s1">&#39;Posterior marginal distribution of k&#39;</span><span class="p">)</span>

<span class="n">savefig</span><span class="p">(</span><span class="s1">&#39;fig12-02&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/chap12_43_0.png" src="_images/chap12_43_0.png" />
</div>
</div>
</div>
<div class="section" id="incomplete-data">
<h2>Incomplete data<a class="headerlink" href="#incomplete-data" title="Permalink to this headline">¶</a></h2>
<p>In the previous example we were given 10 random values from a Weibull distribution, and we used them to estimate the parameters (which we pretended we didn’t know).</p>
<p>But in many real-world scenarios, we don’t have complete data; in particular, when we observe a system at a point in time, we generally have information about the past, but not the future.</p>
<p>As an example, suppose you work at a dog shelter and you are interested in the time between the arrival of a new dog and when it is adopted.
Some dogs might be snapped up immediately; others might have to wait longer.
The people who operate the shelter might want to make inferences about the distribution of these residence times.</p>
<p>Suppose you monitor arrivals and departures over a 8 weeks, and 10 dogs arrive during that period.
I’ll assume that their arrival times are distributed uniformly, so I’ll generate random values like this.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">19</span><span class="p">)</span>
<span class="n">start</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
<span class="n">start</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-none notranslate"><div class="highlight"><pre><span></span>3.8042181089023757
</pre></div>
</div>
</div>
</div>
<p>Now let’s suppose that the dataset we generated in the previous section contains the residence times of the 10 dogs in weeks.
We can use it to construct a <code class="docutils literal notranslate"><span class="pre">DataFrame</span></code> that contains the arrival time and departure time for each dog, <code class="docutils literal notranslate"><span class="pre">start</span></code> and <code class="docutils literal notranslate"><span class="pre">end</span></code>.
And I’ll add a third column, <code class="docutils literal notranslate"><span class="pre">status</span></code>, which indicates whether the dog has been adopted.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">obs</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>

<span class="n">obs</span><span class="p">[</span><span class="s1">&#39;start&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">start</span>
<span class="n">obs</span><span class="p">[</span><span class="s1">&#39;end&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">start</span> <span class="o">+</span> <span class="n">data</span>
<span class="n">obs</span><span class="p">[</span><span class="s1">&#39;status&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>

<span class="n">obs</span> <span class="o">=</span> <span class="n">obs</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="s1">&#39;start&#39;</span><span class="p">,</span> <span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">obs</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>start</th>
      <th>end</th>
      <th>status</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>0.663997</td>
      <td>3.921447</td>
      <td>1</td>
    </tr>
    <tr>
      <th>1</th>
      <td>0.780269</td>
      <td>1.585242</td>
      <td>1</td>
    </tr>
    <tr>
      <th>2</th>
      <td>1.105053</td>
      <td>1.213680</td>
      <td>1</td>
    </tr>
    <tr>
      <th>3</th>
      <td>1.975504</td>
      <td>2.408592</td>
      <td>1</td>
    </tr>
    <tr>
      <th>4</th>
      <td>2.651573</td>
      <td>7.824921</td>
      <td>1</td>
    </tr>
    <tr>
      <th>5</th>
      <td>5.085286</td>
      <td>6.169150</td>
      <td>1</td>
    </tr>
    <tr>
      <th>6</th>
      <td>5.375817</td>
      <td>8.431375</td>
      <td>1</td>
    </tr>
    <tr>
      <th>7</th>
      <td>6.089998</td>
      <td>8.205769</td>
      <td>1</td>
    </tr>
    <tr>
      <th>8</th>
      <td>6.452750</td>
      <td>8.926761</td>
      <td>1</td>
    </tr>
    <tr>
      <th>9</th>
      <td>7.861935</td>
      <td>7.915343</td>
      <td>1</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<p>I’ll use the following function to plot a “lifeline” for each dog, showing the arrival and departure times on a time line.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">plot_lifelines</span><span class="p">(</span><span class="n">obs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Plot a line for each observation.</span>
<span class="sd">    </span>
<span class="sd">    obs: DataFrame</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">for</span> <span class="n">y</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">obs</span><span class="o">.</span><span class="n">iterrows</span><span class="p">():</span>
        <span class="n">start</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;start&#39;</span><span class="p">]</span>
        <span class="n">end</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;end&#39;</span><span class="p">]</span>
        <span class="n">status</span> <span class="o">=</span> <span class="n">row</span><span class="p">[</span><span class="s1">&#39;status&#39;</span><span class="p">]</span>
        
        <span class="k">if</span> <span class="n">status</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="c1"># ongoing</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">hlines</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;C0&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># complete</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">hlines</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;C1&#39;</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">end</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;C1&#39;</span><span class="p">)</span>
            
    <span class="n">decorate</span><span class="p">(</span><span class="n">xlabel</span><span class="o">=</span><span class="s1">&#39;Time (weeks)&#39;</span><span class="p">,</span>
             <span class="n">ylabel</span><span class="o">=</span><span class="s1">&#39;Dog index&#39;</span><span class="p">)</span>

    <span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span><span class="o">.</span><span class="n">invert_yaxis</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<p>And here’s what it looks like for the data we just generated.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">plot_lifelines</span><span class="p">(</span><span class="n">obs</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/chap12_51_0.png" src="_images/chap12_51_0.png" />
</div>
</div>
<p>The start times are disributed uniformly, but the lengths of the lines are highly variable.  For example, Dog 2 was adopted almost immediately; Dog 4 had to wait more than 5 weeks.</p>
<p>But notice that several of the lifelines extend past the observation window of 8 weeks.
So if we observed this system at the beginning of Week 8, we would have incomplete information.
Specifically, we would not know the future adoption times for Dogs 6, 7, and 8.</p>
<p>I’ll simulate this incomplete data by identifying the lifelines that extend past the observation window:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">obs2</span> <span class="o">=</span> <span class="n">obs</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<span class="n">censored</span> <span class="o">=</span> <span class="n">obs2</span><span class="p">[</span><span class="s1">&#39;end&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">8</span>
</pre></div>
</div>
</div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">censored</span></code> is a  Boolean Series that is <code class="docutils literal notranslate"><span class="pre">True</span></code> for lifelines that extend past Week 8.</p>
<p>Data that is not available is sometimes called “censored” in the sense that it is hidden from us.
But in this case it is hidden because we don’t know the future, not because someone is censoring it.</p>
<p>For the lifelines that are censored, I’ll modify <code class="docutils literal notranslate"><span class="pre">end</span></code> to indicate when they are last observed and <code class="docutils literal notranslate"><span class="pre">status</span></code> to indicate that the observation is incomplete.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">obs2</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">censored</span><span class="p">,</span> <span class="s1">&#39;end&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">8</span>
<span class="n">obs2</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">censored</span><span class="p">,</span> <span class="s1">&#39;status&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
</pre></div>
</div>
</div>
</div>
<p>And we can plot the results to show both complete and incomplete lifelines.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">plot_lifelines</span><span class="p">(</span><span class="n">obs2</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/chap12_57_0.png" src="_images/chap12_57_0.png" />
</div>
</div>
<p>And I’ll add one more column to the table, which contains the duration of the observed parts of the lifelines.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">obs2</span><span class="p">[</span><span class="s1">&#39;T&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">obs2</span><span class="p">[</span><span class="s1">&#39;end&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">obs2</span><span class="p">[</span><span class="s1">&#39;start&#39;</span><span class="p">]</span>
<span class="n">obs2</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>start</th>
      <th>end</th>
      <th>status</th>
      <th>T</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>0.663997</td>
      <td>3.921447</td>
      <td>1</td>
      <td>3.257451</td>
    </tr>
    <tr>
      <th>1</th>
      <td>0.780269</td>
      <td>1.585242</td>
      <td>1</td>
      <td>0.804973</td>
    </tr>
    <tr>
      <th>2</th>
      <td>1.105053</td>
      <td>1.213680</td>
      <td>1</td>
      <td>0.108626</td>
    </tr>
    <tr>
      <th>3</th>
      <td>1.975504</td>
      <td>2.408592</td>
      <td>1</td>
      <td>0.433088</td>
    </tr>
    <tr>
      <th>4</th>
      <td>2.651573</td>
      <td>7.824921</td>
      <td>1</td>
      <td>5.173349</td>
    </tr>
    <tr>
      <th>5</th>
      <td>5.085286</td>
      <td>6.169150</td>
      <td>1</td>
      <td>1.083864</td>
    </tr>
    <tr>
      <th>6</th>
      <td>5.375817</td>
      <td>8.000000</td>
      <td>0</td>
      <td>2.624183</td>
    </tr>
    <tr>
      <th>7</th>
      <td>6.089998</td>
      <td>8.000000</td>
      <td>0</td>
      <td>1.910002</td>
    </tr>
    <tr>
      <th>8</th>
      <td>6.452750</td>
      <td>8.000000</td>
      <td>0</td>
      <td>1.547250</td>
    </tr>
    <tr>
      <th>9</th>
      <td>7.861935</td>
      <td>7.915343</td>
      <td>1</td>
      <td>0.053408</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<p>What we have simulated is the data that would be available at the beginning of Week 8.</p>
</div>
<div class="section" id="using-incomplete-data">
<h2>Using incomplete data<a class="headerlink" href="#using-incomplete-data" title="Permalink to this headline">¶</a></h2>
<p>Now, let’s see how we can use both kinds of data, complete and incomplete, to infer the parameters of the distribution of residence times.</p>
<p>First I’ll split the data into two sets: <code class="docutils literal notranslate"><span class="pre">data1</span></code> contains residence times for dogs whose arrival and departure times are known; <code class="docutils literal notranslate"><span class="pre">data2</span></code> contains incomplete residence times for dogs who were not adopted during the observation interval.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">complete</span> <span class="o">=</span> <span class="n">obs2</span><span class="p">[</span><span class="s1">&#39;status&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span>
<span class="n">data1</span> <span class="o">=</span> <span class="n">obs2</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">complete</span><span class="p">,</span> <span class="s1">&#39;T&#39;</span><span class="p">]</span>
<span class="n">data1</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-none notranslate"><div class="highlight"><pre><span></span>0    3.257451
1    0.804973
2    0.108626
3    0.433088
4    5.173349
5    1.083864
9    0.053408
Name: T, dtype: float64
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">data2</span> <span class="o">=</span> <span class="n">obs2</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="o">~</span><span class="n">complete</span><span class="p">,</span> <span class="s1">&#39;T&#39;</span><span class="p">]</span>
<span class="n">data2</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-none notranslate"><div class="highlight"><pre><span></span>6    2.624183
7    1.910002
8    1.547250
Name: T, dtype: float64
</pre></div>
</div>
</div>
</div>
<p>For the complete data, we can use <code class="docutils literal notranslate"><span class="pre">update_weibull</span></code>, which uses the PDF of the Weibull distribution to compute the likelihood of the data.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">posterior1</span> <span class="o">=</span> <span class="n">update_weibull</span><span class="p">(</span><span class="n">prior</span><span class="p">,</span> <span class="n">data1</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>For the incomplete data, we have to think a little harder.
At the end of the observation interval, we don’t know what the residence time will be, but we can put a lower bound on it; that is, we can say that the residence time will be greater than <code class="docutils literal notranslate"><span class="pre">T</span></code>.</p>
<p>And that means that we can compute the likelihood of the data using the survival function, which is the probability that a value from the distribution exceeds <code class="docutils literal notranslate"><span class="pre">T</span></code>.</p>
<p>The following function is identical to <code class="docutils literal notranslate"><span class="pre">update_weibull</span></code> except that it uses <code class="docutils literal notranslate"><span class="pre">sf</span></code>, which computes the survival function, rather than <code class="docutils literal notranslate"><span class="pre">pdf</span></code>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">utils</span> <span class="kn">import</span> <span class="n">normalize</span>

<span class="k">def</span> <span class="nf">update_weibull_incomplete</span><span class="p">(</span><span class="n">prior</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Update the prior based on data.</span>
<span class="sd">    </span>
<span class="sd">    prior: joint distribution of mu and sigma</span>
<span class="sd">    data: sequence of observations</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">lam_mesh</span><span class="p">,</span> <span class="n">k_mesh</span><span class="p">,</span> <span class="n">data_mesh</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="n">prior</span><span class="o">.</span><span class="n">columns</span><span class="p">,</span> <span class="n">prior</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
    <span class="n">densities</span> <span class="o">=</span> <span class="n">weibull_dist</span><span class="p">(</span><span class="n">lam_mesh</span><span class="p">,</span> <span class="n">k_mesh</span><span class="p">)</span><span class="o">.</span><span class="n">sf</span><span class="p">(</span><span class="n">data_mesh</span><span class="p">)</span>
    <span class="n">likelihood</span> <span class="o">=</span> <span class="n">densities</span><span class="o">.</span><span class="n">prod</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>

    <span class="n">posterior</span> <span class="o">=</span> <span class="n">prior</span> <span class="o">*</span> <span class="n">likelihood</span>
    <span class="n">normalize</span><span class="p">(</span><span class="n">posterior</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">posterior</span>
</pre></div>
</div>
</div>
</div>
<p>Here’s the update with the incomplete data.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">posterior2</span> <span class="o">=</span> <span class="n">update_weibull_incomplete</span><span class="p">(</span><span class="n">posterior1</span><span class="p">,</span> <span class="n">data2</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>And here’s what the joint posterior distribution looks like after both updates.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">plot_contour</span><span class="p">(</span><span class="n">posterior2</span><span class="p">)</span>

<span class="n">savefig</span><span class="p">(</span><span class="s1">&#39;fig12-03&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/chap12_71_0.png" src="_images/chap12_71_0.png" />
</div>
</div>
<p>Compared to the previous contour plot, it looks like the range of likely values for <span class="math notranslate nohighlight">\(\lambda\)</span> is substantially wider.
We can see that more clearly by looking at the marginal distributions.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">posterior_lam2</span> <span class="o">=</span> <span class="n">marginal</span><span class="p">(</span><span class="n">posterior2</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
<span class="n">posterior_k2</span> <span class="o">=</span> <span class="n">marginal</span><span class="p">(</span><span class="n">posterior2</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Here’s the posterior marginal distribution for <span class="math notranslate nohighlight">\(\lambda\)</span> compared to the distribution we got using all complete data.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">posterior_lam</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;all complete&#39;</span><span class="p">)</span>
<span class="n">posterior_lam2</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="s1">&#39;some censored&#39;</span><span class="p">)</span>

<span class="n">decorate</span><span class="p">(</span><span class="n">xlabel</span><span class="o">=</span><span class="s1">&#39;lam&#39;</span><span class="p">,</span>
         <span class="n">ylabel</span><span class="o">=</span><span class="s1">&#39;PDF&#39;</span><span class="p">,</span> 
         <span class="n">title</span><span class="o">=</span><span class="s1">&#39;Posterior marginal distribution of lam&#39;</span><span class="p">)</span>

<span class="n">posterior_lam</span><span class="o">.</span><span class="n">mean</span><span class="p">(),</span> <span class="n">posterior_lam</span><span class="o">.</span><span class="n">credible_interval</span><span class="p">(</span><span class="mf">0.9</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-none notranslate"><div class="highlight"><pre><span></span>(2.406081938305909, array([1.189, 4.357]))
</pre></div>
</div>
<img alt="_images/chap12_75_1.png" src="_images/chap12_75_1.png" />
</div>
</div>
<p>Visually, the distribution with some incomplete data is substantially wider, and the 90% credible interval is wider, too.</p>
<p>As an aside, notice that the posterior distribution does not come all the way to 0 on the right side.
That suggests that the range of the prior distribution is not wide enough to cover the most likely values for this parameter.
If I were concerned about making this distribution more accurate, I would go back and run the update again with a wider prior.</p>
<p>Here’s the posterior marginal distribution for <span class="math notranslate nohighlight">\(k\)</span>:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">posterior_k</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;all complete&#39;</span><span class="p">)</span>
<span class="n">posterior_k2</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="s1">&#39;some censored&#39;</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="mf">0.8</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">)</span>
<span class="n">decorate</span><span class="p">(</span><span class="n">xlabel</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span>
         <span class="n">ylabel</span><span class="o">=</span><span class="s1">&#39;PDF&#39;</span><span class="p">,</span> 
         <span class="n">title</span><span class="o">=</span><span class="s1">&#39;Posterior marginal distribution of k&#39;</span><span class="p">)</span>

<span class="n">posterior_k</span><span class="o">.</span><span class="n">mean</span><span class="p">(),</span> <span class="n">posterior_k</span><span class="o">.</span><span class="n">credible_interval</span><span class="p">(</span><span class="mf">0.9</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-none notranslate"><div class="highlight"><pre><span></span>(0.9640523544883197, array([0.59 , 1.423]))
</pre></div>
</div>
<img alt="_images/chap12_77_1.png" src="_images/chap12_77_1.png" />
</div>
</div>
<p>In this example, the marginal distribution is shifted to the left when we have incomplete data, but it is not substantially wider.</p>
<p>In summary, we have seen how to combine complete and incomplete data to estimate the parameters of a Weibull distribution, which is useful in many real-world scenarios where some of the data are censored.</p>
<p>In general, the posterior distributions are wider when we have incomplete data, because less information leads to more uncertainty.</p>
<p>This example is based on data I generated; in the next section we’ll do a similar analysis with real data.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>

<span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<span class="n">posterior_lam</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;all complete&#39;</span><span class="p">)</span>
<span class="n">posterior_lam2</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="s1">&#39;some censored&#39;</span><span class="p">)</span>
<span class="n">decorate</span><span class="p">(</span><span class="n">xlabel</span><span class="o">=</span><span class="s1">&#39;lam&#39;</span><span class="p">,</span>
         <span class="n">ylabel</span><span class="o">=</span><span class="s1">&#39;PDF&#39;</span><span class="p">,</span> 
         <span class="n">title</span><span class="o">=</span><span class="s1">&#39;Posterior marginal distribution of lam&#39;</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
<span class="n">posterior_k</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;all complete&#39;</span><span class="p">)</span>
<span class="n">posterior_k2</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="s1">&#39;some censored&#39;</span><span class="p">)</span>
<span class="n">decorate</span><span class="p">(</span><span class="n">xlabel</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span>
         <span class="n">ylabel</span><span class="o">=</span><span class="s1">&#39;PDF&#39;</span><span class="p">,</span> 
         <span class="n">title</span><span class="o">=</span><span class="s1">&#39;Posterior marginal distribution of k&#39;</span><span class="p">)</span>

<span class="n">savefig</span><span class="p">(</span><span class="s1">&#39;fig12-04&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/chap12_79_0.png" src="_images/chap12_79_0.png" />
</div>
</div>
</div>
<div class="section" id="lightbulbs">
<h2>Lightbulbs<a class="headerlink" href="#lightbulbs" title="Permalink to this headline">¶</a></h2>
<p>In 2007 <a class="reference external" href="https://www.researchgate.net/publication/225450325_Renewal_Rate_of_Filament_Lamps_Theory_and_Experiment">researchers ran an experiment</a> to characterize the distribution of lifetimes for lightbulbs.</p>
<p>Here is their description of the experiment:</p>
<blockquote>
<div><p>An assembly of 50 new Philips (India) lamps with the rating 40 W, 220 V (AC) was taken and installed in the horizontal orientation and uniformly distributed over a lab area 11 m x 7 m.</p>
<p>The assembly was monitored at regular intervals of 12 h to look for failures. The instants of recorded failures were [recorded] and a total of 32 data points were obtained such that even the last bulb failed.</p>
</div></blockquote>
<p>The data were reported in the following columns:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">i</span> <span class="o">-</span> <span class="n">observation</span> <span class="n">number</span>
<span class="n">h</span> <span class="o">-</span> <span class="n">time</span> <span class="ow">in</span> <span class="n">hours</span> <span class="n">since</span> <span class="n">experiment</span> <span class="n">start</span>
<span class="n">f</span> <span class="o">-</span> <span class="n">number</span> <span class="n">of</span> <span class="n">failed</span> <span class="n">lamps</span> <span class="n">at</span> <span class="n">particular</span> <span class="n">time</span> <span class="n">h</span>
<span class="n">K</span> <span class="o">-</span> <span class="n">number</span> <span class="n">of</span> <span class="n">surviving</span> <span class="n">lamps</span>  <span class="n">at</span> <span class="n">particular</span> <span class="n">time</span> <span class="n">h</span>
</pre></div>
</div>
<p>We can download the data here:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span># Load the data file

datafile = &#39;lamps.csv&#39;
if not os.path.exists(datafile):
    !wget https://gist.github.com/epogrebnyak/7933e16c0ad215742c4c104be4fbdeb1/raw/c932bc5b6aa6317770c4cbf43eb591511fec08f9/lamps.csv
</pre></div>
</div>
</div>
</div>
<p>And load it into a <code class="docutils literal notranslate"><span class="pre">DataFrame</span></code> like this:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s1">&#39;lamps.csv&#39;</span><span class="p">,</span> <span class="n">index_col</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">df</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>h</th>
      <th>f</th>
      <th>K</th>
    </tr>
    <tr>
      <th>i</th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>0</td>
      <td>0</td>
      <td>50</td>
    </tr>
    <tr>
      <th>1</th>
      <td>840</td>
      <td>2</td>
      <td>48</td>
    </tr>
    <tr>
      <th>2</th>
      <td>852</td>
      <td>1</td>
      <td>47</td>
    </tr>
    <tr>
      <th>3</th>
      <td>936</td>
      <td>1</td>
      <td>46</td>
    </tr>
    <tr>
      <th>4</th>
      <td>960</td>
      <td>1</td>
      <td>45</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<p>Column <code class="docutils literal notranslate"><span class="pre">h</span></code> contains the time values when bulbs failed; Column <code class="docutils literal notranslate"><span class="pre">f</span></code> contains the number of bulbs that failed at each time.
We can represent these values and frequencies using a <code class="docutils literal notranslate"><span class="pre">Pmf</span></code>, like this:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">pmf_bulb</span> <span class="o">=</span> <span class="n">Pmf</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;f&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">(),</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;h&#39;</span><span class="p">])</span>
<span class="n">pmf_bulb</span><span class="o">.</span><span class="n">normalize</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-none notranslate"><div class="highlight"><pre><span></span>50
</pre></div>
</div>
</div>
</div>
<p>Because of the design of this experiment, we can consider the data to be a representative sample from the distribution of lifetimes, at least for light bulbs that are lit continuously.</p>
<p>The average lifetime is about 1400 h.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">pmf_bulb</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-none notranslate"><div class="highlight"><pre><span></span>1413.84
</pre></div>
</div>
</div>
</div>
<p>Here’s what the distribution looks like.
I’ll plot the CDF of the data along with the CDF of a Weibull distribution I chose to fit the data.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">pmf_bulb</span><span class="o">.</span><span class="n">make_cdf</span><span class="p">()</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="s1">&#39;data&#39;</span><span class="p">)</span>

<span class="n">qs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2500</span><span class="p">,</span> <span class="mi">101</span><span class="p">)</span>
<span class="n">ps</span> <span class="o">=</span> <span class="n">weibull_dist</span><span class="p">(</span><span class="mi">1500</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span><span class="o">.</span><span class="n">cdf</span><span class="p">(</span><span class="n">qs</span><span class="p">)</span>
<span class="n">cdf</span> <span class="o">=</span> <span class="n">Cdf</span><span class="p">(</span><span class="n">ps</span><span class="p">,</span> <span class="n">qs</span><span class="p">)</span>
<span class="n">cdf</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="s1">&#39;Weibull distribution&#39;</span><span class="p">)</span>

<span class="n">decorate</span><span class="p">(</span><span class="n">xlabel</span><span class="o">=</span><span class="s1">&#39;Lightbulb lifetime (h)&#39;</span><span class="p">,</span>
         <span class="n">ylabel</span><span class="o">=</span><span class="s1">&#39;CDF&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/chap12_89_0.png" src="_images/chap12_89_0.png" />
</div>
</div>
<p>It looks like the Weibull distribution is a good model for the data.
So we should be able to use the data to infer the parameters of the model.</p>
<p>Again, I’ll start with uniform priors for <span class="math notranslate nohighlight">\(\lambda\)</span> and <span class="math notranslate nohighlight">\(k\)</span>:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">lams</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">1000</span><span class="p">,</span> <span class="mi">2000</span><span class="p">,</span> <span class="mi">51</span><span class="p">)</span>
<span class="n">prior_lam</span> <span class="o">=</span> <span class="n">Pmf</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">lams</span><span class="p">)</span>
<span class="n">prior_lam</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;lambda&#39;</span>
<span class="n">prior_lam</span><span class="o">.</span><span class="n">normalize</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-none notranslate"><div class="highlight"><pre><span></span>51
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">ks</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">51</span><span class="p">)</span>
<span class="n">prior_k</span> <span class="o">=</span> <span class="n">Pmf</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">ks</span><span class="p">)</span>
<span class="n">prior_k</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;k&#39;</span>
<span class="n">prior_k</span><span class="o">.</span><span class="n">normalize</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-none notranslate"><div class="highlight"><pre><span></span>51
</pre></div>
</div>
</div>
</div>
<p>For this example, there are 51 values in the prior distribtion, rather than the usual 101.  That’s because we are going to use the posterior distributions to do some computationally-intensive calculations.
They will run faster with fewer values, but the results will be less precise.</p>
<p>As usual, we can use <code class="docutils literal notranslate"><span class="pre">make_joint</span></code> to make the prior joint distribution.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">prior_bulb</span> <span class="o">=</span> <span class="n">make_joint</span><span class="p">(</span><span class="n">prior_lam</span><span class="p">,</span> <span class="n">prior_k</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Although we have data for 50 lightbulbs, there are only 32 unique lifetimes in the dataset.  For the update, it is convenient to express the data in the form of 50 lifetimes, with each lifetime repeated the given number of times.
We can use <code class="docutils literal notranslate"><span class="pre">np.repeat</span></code> to transform the data.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">data_bulb</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;h&#39;</span><span class="p">],</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;f&#39;</span><span class="p">])</span>
<span class="nb">len</span><span class="p">(</span><span class="n">data_bulb</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-none notranslate"><div class="highlight"><pre><span></span>50
</pre></div>
</div>
</div>
</div>
<p>Now we can use <code class="docutils literal notranslate"><span class="pre">update_weibull</span></code> to do the update.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">posterior_bulb</span> <span class="o">=</span> <span class="n">update_weibull</span><span class="p">(</span><span class="n">prior_bulb</span><span class="p">,</span> <span class="n">data_bulb</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Here’s what the posterior joint distribution looks like:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">plot_contour</span><span class="p">(</span><span class="n">posterior_bulb</span><span class="p">)</span>
<span class="n">decorate</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="s1">&#39;Posterior joint distribution of Weibull parameters&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/chap12_100_0.png" src="_images/chap12_100_0.png" />
</div>
</div>
<p>But that’s not quite right, because it assumes each lightbulb died at the instant we observed it.  But apparently the researchers only checked the bulbs every 12 hours.  So if they see that a bulb has died, they know only that it died during the 12 hours since the last check.</p>
<p>So it is more strictly correct to use the following update function, which uses the CDF of the Weibull distribution to compute the probability that a bulb dies during a given 12 hour interval.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">update_weibull_between</span><span class="p">(</span><span class="n">prior</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">dt</span><span class="o">=</span><span class="mi">12</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Update the prior based on data.</span>
<span class="sd">    </span>
<span class="sd">    prior: joint distribution of mu and sigma</span>
<span class="sd">    data: sequence of observations</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">lam_mesh</span><span class="p">,</span> <span class="n">k_mesh</span><span class="p">,</span> <span class="n">data_mesh</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="n">prior</span><span class="o">.</span><span class="n">columns</span><span class="p">,</span> <span class="n">prior</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
    <span class="n">dist</span> <span class="o">=</span> <span class="n">weibull_dist</span><span class="p">(</span><span class="n">lam_mesh</span><span class="p">,</span> <span class="n">k_mesh</span><span class="p">)</span>
    <span class="n">cdf1</span> <span class="o">=</span> <span class="n">dist</span><span class="o">.</span><span class="n">cdf</span><span class="p">(</span><span class="n">data_mesh</span><span class="p">)</span>
    <span class="n">cdf2</span> <span class="o">=</span> <span class="n">dist</span><span class="o">.</span><span class="n">cdf</span><span class="p">(</span><span class="n">data_mesh</span><span class="o">-</span><span class="mi">12</span><span class="p">)</span>
    <span class="n">likelihood</span> <span class="o">=</span> <span class="p">(</span><span class="n">cdf1</span> <span class="o">-</span> <span class="n">cdf2</span><span class="p">)</span><span class="o">.</span><span class="n">prod</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>

    <span class="n">posterior</span> <span class="o">=</span> <span class="n">prior</span> <span class="o">*</span> <span class="n">likelihood</span>
    <span class="n">normalize</span><span class="p">(</span><span class="n">posterior</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">posterior</span>
</pre></div>
</div>
</div>
</div>
<p>The probability that a value falls in an interval is the difference between the CDF at the beginning and end.</p>
<p>Here’s how we run the update.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">posterior_bulb2</span> <span class="o">=</span> <span class="n">update_weibull_between</span><span class="p">(</span><span class="n">prior_bulb</span><span class="p">,</span> <span class="n">data_bulb</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>And here are the results.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">plot_contour</span><span class="p">(</span><span class="n">posterior_bulb2</span><span class="p">)</span>
<span class="n">decorate</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="s1">&#39;Posterior joint distribution of Weibull parameters&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/chap12_106_0.png" src="_images/chap12_106_0.png" />
</div>
</div>
<p>Visually this result is almost identical to what we got using the PDF.
And that’s good news, because it suggests that using the PDF can be a good approximation even if it’s not strictly correct.</p>
<p>To see whether it makes any difference at all, let’s check the posterior means.</p>
</div>
<div class="section" id="posterior-means">
<h2>Posterior means<a class="headerlink" href="#posterior-means" title="Permalink to this headline">¶</a></h2>
<p>To compute the posterior mean of the joint distribution we can enumerate the parameters and their probabilities.
For each pair of parameters, <span class="math notranslate nohighlight">\(\lambda\)</span> and <span class="math notranslate nohighlight">\(k\)</span>, we use <code class="docutils literal notranslate"><span class="pre">weibull_dist</span></code> to compute the mean, which is</p>
<p><span class="math notranslate nohighlight">\(\lambda \, \Gamma(1+1/k)\)</span></p>
<p>where <span class="math notranslate nohighlight">\(\Gamma\)</span> is the <a class="reference external" href="https://en.wikipedia.org/wiki/Gamma_function">gamma function</a>.</p>
<p>Then, using the probabilities as weights, we add up the total posterior mean.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">joint_weibull_mean</span><span class="p">(</span><span class="n">joint</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Compute the mean of a joint distribution of Weibulls.</span>
<span class="sd">    </span>
<span class="sd">    joint: DataFrame of Weibull parameters and probabilities</span>
<span class="sd">    </span>
<span class="sd">    returns: expected mean value</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">pmf</span> <span class="o">=</span> <span class="n">Pmf</span><span class="p">(</span><span class="n">joint</span><span class="o">.</span><span class="n">stack</span><span class="p">())</span>
    <span class="n">total</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">lam</span><span class="p">),</span> <span class="n">prob</span> <span class="ow">in</span> <span class="n">pmf</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">mean</span> <span class="o">=</span> <span class="n">weibull_dist</span><span class="p">(</span><span class="n">lam</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
        <span class="n">total</span> <span class="o">+=</span> <span class="n">prob</span> <span class="o">*</span> <span class="n">mean</span>
    <span class="k">return</span> <span class="n">total</span>
</pre></div>
</div>
</div>
</div>
<p>Here are the means of the two posterior distributions:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">joint_weibull_mean</span><span class="p">(</span><span class="n">posterior_bulb</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-none notranslate"><div class="highlight"><pre><span></span>1412.724277430501
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">joint_weibull_mean</span><span class="p">(</span><span class="n">posterior_bulb2</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-none notranslate"><div class="highlight"><pre><span></span>1406.8171982320873
</pre></div>
</div>
</div>
</div>
<p>When we take into account the 12 hour interval between observations, the posterior mean is about 6 hours less.
If we assume that a bulb is equally likely to expire at any point in the interval, which is at least approximately true, the 6 hour difference makes sense.</p>
<p>As the number of elements in the joint distribution increases, it can become expensive to enumerate all pairs of parameters.
An alternative is to draw a random sample from the joint distribution, using the probabilities of weights.
As an example, I’ll use random sampling to estimate the posterior mean we just computed.</p>
<p>As in <code class="docutils literal notranslate"><span class="pre">joint_weibull_mean</span></code>, we’ll start by stacking the joint distribution.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">posterior_pmf</span> <span class="o">=</span> <span class="n">Pmf</span><span class="p">(</span><span class="n">posterior_bulb2</span><span class="o">.</span><span class="n">stack</span><span class="p">())</span>
<span class="n">posterior_pmf</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th></th>
      <th>probs</th>
    </tr>
    <tr>
      <th>k</th>
      <th>lambda</th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th rowspan="5" valign="top">1.0</th>
      <th>1000.0</th>
      <td>1.080654e-24</td>
    </tr>
    <tr>
      <th>1020.0</th>
      <td>1.596253e-24</td>
    </tr>
    <tr>
      <th>1040.0</th>
      <td>2.279356e-24</td>
    </tr>
    <tr>
      <th>1060.0</th>
      <td>3.153589e-24</td>
    </tr>
    <tr>
      <th>1080.0</th>
      <td>4.236317e-24</td>
    </tr>
    <tr>
      <th>...</th>
      <th>...</th>
      <td>...</td>
    </tr>
    <tr>
      <th rowspan="5" valign="top">10.0</th>
      <th>1920.0</th>
      <td>9.697504e-36</td>
    </tr>
    <tr>
      <th>1940.0</th>
      <td>6.517344e-37</td>
    </tr>
    <tr>
      <th>1960.0</th>
      <td>3.541780e-38</td>
    </tr>
    <tr>
      <th>1980.0</th>
      <td>1.603116e-39</td>
    </tr>
    <tr>
      <th>2000.0</th>
      <td>6.201824e-41</td>
    </tr>
  </tbody>
</table>
<p>2601 rows × 1 columns</p>
</div></div></div>
</div>
<p>The result is a <code class="docutils literal notranslate"><span class="pre">Pmf</span></code> with a <code class="docutils literal notranslate"><span class="pre">MultiIndex</span></code> that contains the parameters.
If we reset the index, the parameters become named columns, and the probabilities are put in a column with the label <code class="docutils literal notranslate"><span class="pre">0</span></code>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">reset</span> <span class="o">=</span> <span class="n">posterior_pmf</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
<span class="n">reset</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>k</th>
      <th>lambda</th>
      <th>0</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>1.0</td>
      <td>1000.0</td>
      <td>1.080654e-24</td>
    </tr>
    <tr>
      <th>1</th>
      <td>1.0</td>
      <td>1020.0</td>
      <td>1.596253e-24</td>
    </tr>
    <tr>
      <th>2</th>
      <td>1.0</td>
      <td>1040.0</td>
      <td>2.279356e-24</td>
    </tr>
    <tr>
      <th>3</th>
      <td>1.0</td>
      <td>1060.0</td>
      <td>3.153589e-24</td>
    </tr>
    <tr>
      <th>4</th>
      <td>1.0</td>
      <td>1080.0</td>
      <td>4.236317e-24</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<p>The new index contains integers starting from 0.
We can use <code class="docutils literal notranslate"><span class="pre">np.random.choice</span></code> to choose random labels from the new index, weighted with the probabilities from the <code class="docutils literal notranslate"><span class="pre">Pmf</span></code>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">index</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">reset</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">p</span><span class="o">=</span><span class="n">posterior_pmf</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">1000</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">chosen</span> <span class="o">=</span> <span class="n">reset</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>
<span class="n">chosen</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>k</th>
      <th>lambda</th>
      <th>0</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>843</th>
      <td>3.88</td>
      <td>1540.0</td>
      <td>0.016875</td>
    </tr>
    <tr>
      <th>947</th>
      <td>4.24</td>
      <td>1580.0</td>
      <td>0.019609</td>
    </tr>
    <tr>
      <th>947</th>
      <td>4.24</td>
      <td>1580.0</td>
      <td>0.019609</td>
    </tr>
    <tr>
      <th>844</th>
      <td>3.88</td>
      <td>1560.0</td>
      <td>0.014567</td>
    </tr>
    <tr>
      <th>792</th>
      <td>3.70</td>
      <td>1540.0</td>
      <td>0.010069</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<p>The result is a <code class="docutils literal notranslate"><span class="pre">DataFrame</span></code> with the chosen rows.
Now we can select the parameters, pass them to <code class="docutils literal notranslate"><span class="pre">weibull_dist</span></code>, and use <code class="docutils literal notranslate"><span class="pre">rvs</span></code> to choose one value from each distribution specified by a pair of parameters.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sample</span> <span class="o">=</span> <span class="n">weibull_dist</span><span class="p">(</span><span class="n">chosen</span><span class="p">[</span><span class="s1">&#39;lambda&#39;</span><span class="p">],</span> <span class="n">chosen</span><span class="p">[</span><span class="s1">&#39;k&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">rvs</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<p>The result is a sample from the posterior predictive distribution, which we can use to compute whatever summary statistics we are interested in, including the mean:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sample</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-none notranslate"><div class="highlight"><pre><span></span>1409.0297180847385
</pre></div>
</div>
</div>
</div>
<p>Here are those steps encapsulated in a function.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">joint_weibull_sample</span><span class="p">(</span><span class="n">joint</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="mi">1000</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Sample from a predictive distribution.</span>
<span class="sd">    </span>
<span class="sd">    joint: joint distribution of parameters</span>
<span class="sd">    n: sample size</span>
<span class="sd">    </span>
<span class="sd">    returns: NumPy array of random values</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">pmf</span> <span class="o">=</span> <span class="n">Pmf</span><span class="p">(</span><span class="n">joint</span><span class="o">.</span><span class="n">stack</span><span class="p">())</span>
    <span class="n">reset</span> <span class="o">=</span> <span class="n">pmf</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
    <span class="n">index</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">reset</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">p</span><span class="o">=</span><span class="n">pmf</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">n</span><span class="p">)</span>
    <span class="n">chosen</span> <span class="o">=</span> <span class="n">reset</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>
    <span class="n">sample</span> <span class="o">=</span> <span class="n">weibull_dist</span><span class="p">(</span><span class="n">chosen</span><span class="p">[</span><span class="s1">&#39;lambda&#39;</span><span class="p">],</span> <span class="n">chosen</span><span class="p">[</span><span class="s1">&#39;k&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">rvs</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">sample</span>
</pre></div>
</div>
</div>
</div>
<p>And here’s how we can use it.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sample</span> <span class="o">=</span> <span class="n">joint_weibull_sample</span><span class="p">(</span><span class="n">posterior_bulb2</span><span class="p">)</span>
<span class="n">sample</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-none notranslate"><div class="highlight"><pre><span></span>1422.2688171419734
</pre></div>
</div>
</div>
</div>
<p>As one of the exercises at the end of this chapter, you can write a similar function for the gamma distribution.</p>
</div>
<div class="section" id="summary">
<h2>Summary<a class="headerlink" href="#summary" title="Permalink to this headline">¶</a></h2>
<p>This chapter introduces survival analysis, which is use to answer questions about the time until an event, and the Weibull distribution, which is a good model for “lieftimes”, broadly interpreted, in a number of domains.</p>
<p>We used joint distributions to represent prior probabilities for the parameters of the Weibull distribution, and we updated them three ways: knowing the exact duration of a lifetime, knowing a lower bound, and knowing that a lifetime fell in a given interval.</p>
<p>These examples demonstrate a feature of Bayesian methods: they can be adapted to handle incomplete, or “censored”, data with only small changes.  As an exercise, you’ll have a chance to work with one more type of censored data, when we are given an upper bound on a lifetime.</p>
<p>The methods in this chapter work with any distribution with two parameters.  In the exercises, you’ll have a chance to estimate the parameters of a gamma distribution, which is used to describe a variety of natural phenomena.</p>
<p>And in the next chapter we’ll move on to models with three parameters, which we will use to do Bayesian regression.</p>
</div>
<div class="section" id="exercises">
<h2>Exercises<a class="headerlink" href="#exercises" title="Permalink to this headline">¶</a></h2>
<p><strong>Exercise:</strong> Suppose you install 100 lightbulbs of the kind we studied in this chapter, and you come back to check on them after 1000 hours.  Based on the posterior distribution we just computed, how many lightbulbs do you expect to be dead?  What is the distribution of this number?</p>
<p>Hint: Use <code class="docutils literal notranslate"><span class="pre">make_binomial</span></code> and <code class="docutils literal notranslate"><span class="pre">make_mixture</span></code> to compute the posterior predictive distribution for the number of dead bulbs.</p>
<p>Note: This calculation involves a substantial amount of computation, which is why I made the grid in this chapter coarser than in previous chapters, with 51 values for each parameter rather than 101.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">utils</span> <span class="kn">import</span> <span class="n">make_binomial</span><span class="p">,</span> <span class="n">make_mixture</span>
</pre></div>
</div>
</div>
</div>
<div class="cell tag_hide-cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># Solution</span>

<span class="n">posterior_pmf</span> <span class="o">=</span> <span class="n">Pmf</span><span class="p">(</span><span class="n">posterior_bulb2</span><span class="o">.</span><span class="n">stack</span><span class="p">())</span>
</pre></div>
</div>
</div>
</div>
<div class="cell tag_hide-cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># Solution</span>

<span class="n">t</span> <span class="o">=</span> <span class="mi">1000</span>

<span class="n">total</span> <span class="o">=</span> <span class="mi">0</span>
<span class="k">for</span> <span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">lam</span><span class="p">),</span> <span class="n">prob</span> <span class="ow">in</span> <span class="n">posterior_pmf</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
    <span class="n">prob_dead</span> <span class="o">=</span> <span class="n">weibull_dist</span><span class="p">(</span><span class="n">lam</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span><span class="o">.</span><span class="n">cdf</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
    <span class="n">total</span> <span class="o">+=</span> <span class="n">prob</span> <span class="o">*</span> <span class="n">prob_dead</span>
</pre></div>
</div>
</div>
</div>
<div class="cell tag_hide-cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># Solution</span>

<span class="n">n</span> <span class="o">=</span> <span class="mi">100</span>
<span class="n">total</span> <span class="o">*</span> <span class="n">n</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-none notranslate"><div class="highlight"><pre><span></span>14.945401430072334
</pre></div>
</div>
</div>
</div>
<div class="cell tag_hide-cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># Solution</span>

<span class="n">pmf_seq</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">lam</span><span class="p">),</span> <span class="n">prob</span> <span class="ow">in</span> <span class="n">posterior_pmf</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
    <span class="n">prob_dead</span> <span class="o">=</span> <span class="n">weibull_dist</span><span class="p">(</span><span class="n">lam</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span><span class="o">.</span><span class="n">cdf</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
    <span class="n">pmf</span> <span class="o">=</span> <span class="n">make_binomial</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">prob_dead</span><span class="p">)</span>
    <span class="n">pmf_seq</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pmf</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell tag_hide-cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># Solution</span>

<span class="n">pred</span> <span class="o">=</span> <span class="n">make_mixture</span><span class="p">(</span><span class="n">posterior_pmf</span><span class="p">,</span> <span class="n">pmf_seq</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell tag_hide-cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># Solution</span>

<span class="n">pred</span><span class="o">.</span><span class="n">plot</span><span class="p">()</span>
<span class="n">decorate</span><span class="p">(</span><span class="n">xlabel</span><span class="o">=</span><span class="s1">&#39;Number of dead bulbs&#39;</span><span class="p">,</span>
         <span class="n">ylabel</span><span class="o">=</span><span class="s1">&#39;PMF&#39;</span><span class="p">,</span>
         <span class="n">title</span><span class="o">=</span><span class="s1">&#39;Posterior predictive distribution&#39;</span><span class="p">)</span>

<span class="n">pred</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-none notranslate"><div class="highlight"><pre><span></span>14.945401430072216
</pre></div>
</div>
<img alt="_images/chap12_138_1.png" src="_images/chap12_138_1.png" />
</div>
</div>
<p><strong>Exercise:</strong> Now suppose that when you come back after 1000 hours, you actually find 20 dead lightbulbs.  Update the posterior distribution based on this data.  How much does it change the posterior mean?</p>
<div class="cell tag_hide-cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># Solution</span>

<span class="n">t</span> <span class="o">=</span> <span class="mi">1000</span>

<span class="n">lam_mesh</span><span class="p">,</span> <span class="n">k_mesh</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="n">prior_bulb</span><span class="o">.</span><span class="n">columns</span><span class="p">,</span> <span class="n">prior_bulb</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
<span class="n">prob_dead</span> <span class="o">=</span> <span class="n">weibull_dist</span><span class="p">(</span><span class="n">lam_mesh</span><span class="p">,</span> <span class="n">k_mesh</span><span class="p">)</span><span class="o">.</span><span class="n">cdf</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>
<span class="n">prob_dead</span><span class="o">.</span><span class="n">shape</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-none notranslate"><div class="highlight"><pre><span></span>(51, 51)
</pre></div>
</div>
</div>
</div>
<div class="cell tag_hide-cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># Solution</span>

<span class="kn">from</span> <span class="nn">scipy.stats</span> <span class="kn">import</span> <span class="n">binom</span>

<span class="n">k</span> <span class="o">=</span> <span class="mi">20</span>
<span class="n">n</span> <span class="o">=</span> <span class="mi">100</span>
<span class="n">likelihood</span> <span class="o">=</span> <span class="n">binom</span><span class="o">.</span><span class="n">pmf</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">prob_dead</span><span class="p">)</span>
<span class="n">likelihood</span><span class="o">.</span><span class="n">shape</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-none notranslate"><div class="highlight"><pre><span></span>(51, 51)
</pre></div>
</div>
</div>
</div>
<div class="cell tag_hide-cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># Solution</span>

<span class="n">posterior_bulb3</span> <span class="o">=</span> <span class="n">posterior_bulb2</span> <span class="o">*</span> <span class="n">likelihood</span>
<span class="n">normalize</span><span class="p">(</span><span class="n">posterior_bulb3</span><span class="p">)</span>
<span class="n">plot_contour</span><span class="p">(</span><span class="n">posterior_bulb3</span><span class="p">)</span>
<span class="n">decorate</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="s1">&#39;Posterior joint distribution with k=20&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/chap12_142_0.png" src="_images/chap12_142_0.png" />
</div>
</div>
<div class="cell tag_hide-cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># Solution</span>

<span class="c1"># Since there were more dead bulbs than expected,</span>
<span class="c1"># the posterior mean is a bit less after the update.</span>

<span class="n">joint_weibull_mean</span><span class="p">(</span><span class="n">posterior_bulb3</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-none notranslate"><div class="highlight"><pre><span></span>1374.6787666856153
</pre></div>
</div>
</div>
</div>
<p><strong>Exercise:</strong> According to hydrologists, the distribution of total daily
rainfall (for days with rain) is well modeled by a two-parameter
gamma distribution.</p>
<p>In this exercise, we’ll use one month of data to estimate the parameters of a gamma distribution that describes daily rainfall in Seattle.
Then we’ll compute the posterior predictive distribution for daily rainfall, including the possibility of no rain.</p>
<p>The following cell downloads data I collected from the National Oceanic and Atmospheric Administration (<a class="reference external" href="http://www.ncdc.noaa.gov/cdo-web/search">NOAA</a>) for Seattle, Washington in May 2020.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span># Load the data file

datafile = &#39;2203951.csv&#39;
if not os.path.exists(datafile):
    !wget https://github.com/AllenDowney/ThinkBayes2/raw/master/data/2203951.csv
</pre></div>
</div>
</div>
</div>
<p>Now we can load it into a <code class="docutils literal notranslate"><span class="pre">DataFrame</span></code>:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">weather</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s1">&#39;2203951.csv&#39;</span><span class="p">)</span>
<span class="n">weather</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>STATION</th>
      <th>NAME</th>
      <th>DATE</th>
      <th>AWND</th>
      <th>PRCP</th>
      <th>TMAX</th>
      <th>TMIN</th>
      <th>WT01</th>
      <th>WT03</th>
      <th>WT08</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>USW00024233</td>
      <td>SEATTLE TACOMA AIRPORT, WA US</td>
      <td>2020-05-01</td>
      <td>4.47</td>
      <td>0.00</td>
      <td>66</td>
      <td>43</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>1</th>
      <td>USW00024233</td>
      <td>SEATTLE TACOMA AIRPORT, WA US</td>
      <td>2020-05-02</td>
      <td>9.40</td>
      <td>0.24</td>
      <td>58</td>
      <td>47</td>
      <td>1.0</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>2</th>
      <td>USW00024233</td>
      <td>SEATTLE TACOMA AIRPORT, WA US</td>
      <td>2020-05-03</td>
      <td>11.63</td>
      <td>0.06</td>
      <td>57</td>
      <td>44</td>
      <td>1.0</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>3</th>
      <td>USW00024233</td>
      <td>SEATTLE TACOMA AIRPORT, WA US</td>
      <td>2020-05-04</td>
      <td>4.47</td>
      <td>0.00</td>
      <td>65</td>
      <td>39</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>4</th>
      <td>USW00024233</td>
      <td>SEATTLE TACOMA AIRPORT, WA US</td>
      <td>2020-05-05</td>
      <td>7.83</td>
      <td>0.00</td>
      <td>71</td>
      <td>49</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<p>I’ll make a Boolean Series to indicate which days it rained.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">rained</span> <span class="o">=</span> <span class="n">weather</span><span class="p">[</span><span class="s1">&#39;PRCP&#39;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span>
<span class="n">rained</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-none notranslate"><div class="highlight"><pre><span></span>14
</pre></div>
</div>
</div>
</div>
<p>And select the total rainfall on the days it rained.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">prcp</span> <span class="o">=</span> <span class="n">weather</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">rained</span><span class="p">,</span> <span class="s1">&#39;PRCP&#39;</span><span class="p">]</span>
<span class="n">prcp</span><span class="o">.</span><span class="n">describe</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-none notranslate"><div class="highlight"><pre><span></span>count    14.000000
mean      0.222857
std       0.301060
min       0.010000
25%       0.052500
50%       0.110000
75%       0.225000
max       1.140000
Name: PRCP, dtype: float64
</pre></div>
</div>
</div>
</div>
<p>Here’s what the CDF of the data looks like.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">cdf_data</span> <span class="o">=</span> <span class="n">Cdf</span><span class="o">.</span><span class="n">from_seq</span><span class="p">(</span><span class="n">prcp</span><span class="p">)</span>
<span class="n">cdf_data</span><span class="o">.</span><span class="n">plot</span><span class="p">()</span>
<span class="n">decorate</span><span class="p">(</span><span class="n">xlabel</span><span class="o">=</span><span class="s1">&#39;Total rainfall (in)&#39;</span><span class="p">,</span>
         <span class="n">ylabel</span><span class="o">=</span><span class="s1">&#39;CDF&#39;</span><span class="p">,</span>
         <span class="n">title</span><span class="o">=</span><span class="s1">&#39;Distribution of rainfall on days it rained&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/chap12_153_0.png" src="_images/chap12_153_0.png" />
</div>
</div>
<p>Now I suggest you proceed in the following steps:</p>
<ol class="simple">
<li><p>Construct a prior distribution for the parameters of the gamma distribution.</p></li>
<li><p>Use the observed rainfalls to update the distribution of parameters.</p></li>
<li><p>Generate a sample of 1000 values from the posterior predictive distribution.  This is the distribution of rainfall we expect on the days it rains.</p></li>
<li><p>Then, to estimate the probability of rain.</p></li>
</ol>
<p>For the first step, you might want to use the following function, which creates an object that represents a gamma distribution a shape parameter, <span class="math notranslate nohighlight">\(k\)</span>, and
a scale parameter, <span class="math notranslate nohighlight">\(\theta\)</span>.</p>
<p>The result is an object that provides methods <code class="docutils literal notranslate"><span class="pre">pdf</span></code>, <code class="docutils literal notranslate"><span class="pre">cdf</span></code>, and <code class="docutils literal notranslate"><span class="pre">sf</span></code> that compute the PDF, CDF, and survival function, as well as <code class="docutils literal notranslate"><span class="pre">rvs</span></code>, which generates random values.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">scipy.stats</span>

<span class="k">def</span> <span class="nf">gamma_dist</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">theta</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Makes a gamma object.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">scipy</span><span class="o">.</span><span class="n">stats</span><span class="o">.</span><span class="n">gamma</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="n">theta</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>For Step 4, you might want to use the following function from Chapter 6, which you can use to compute the posterior distribution for the probability of rain.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">scipy.stats</span> <span class="kn">import</span> <span class="n">binom</span>

<span class="k">def</span> <span class="nf">update_binomial</span><span class="p">(</span><span class="n">pmf</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Update the PMF using the binomial distribution.</span>
<span class="sd">    </span>
<span class="sd">    pmf: Pmf representing the prior</span>
<span class="sd">    data: tuple of integers k and n</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">k</span><span class="p">,</span> <span class="n">n</span> <span class="o">=</span> <span class="n">data</span>
    <span class="n">xs</span> <span class="o">=</span> <span class="n">pmf</span><span class="o">.</span><span class="n">qs</span>
    <span class="n">likelihood</span> <span class="o">=</span> <span class="n">binom</span><span class="o">.</span><span class="n">pmf</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">xs</span><span class="p">)</span>
    <span class="n">pmf</span> <span class="o">*=</span> <span class="n">likelihood</span>
    <span class="n">pmf</span><span class="o">.</span><span class="n">normalize</span><span class="p">()</span>
</pre></div>
</div>
</div>
</div>
<p>Now you take it from there.</p>
<div class="cell tag_hide-cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># Solution</span>

<span class="n">ks</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mf">0.01</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">101</span><span class="p">)</span>
<span class="n">prior_k</span> <span class="o">=</span> <span class="n">Pmf</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">ks</span><span class="p">)</span>
<span class="n">prior_k</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;k&#39;</span>
<span class="n">prior_k</span><span class="o">.</span><span class="n">normalize</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-none notranslate"><div class="highlight"><pre><span></span>101
</pre></div>
</div>
</div>
</div>
<div class="cell tag_hide-cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># Solution</span>

<span class="n">thetas</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mf">0.01</span><span class="p">,</span> <span class="mf">1.5</span><span class="p">,</span> <span class="mi">101</span><span class="p">)</span>
<span class="n">prior_theta</span> <span class="o">=</span> <span class="n">Pmf</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">thetas</span><span class="p">)</span>
<span class="n">prior_theta</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;theta&#39;</span>
<span class="n">prior_theta</span><span class="o">.</span><span class="n">normalize</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-none notranslate"><div class="highlight"><pre><span></span>101
</pre></div>
</div>
</div>
</div>
<div class="cell tag_hide-cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># Solution</span>

<span class="n">prior</span> <span class="o">=</span> <span class="n">make_joint</span><span class="p">(</span><span class="n">prior_k</span><span class="p">,</span> <span class="n">prior_theta</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell tag_hide-cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># Solution</span>

<span class="n">k_mesh</span><span class="p">,</span> <span class="n">theta_mesh</span><span class="p">,</span> <span class="n">data_mesh</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="n">prior</span><span class="o">.</span><span class="n">columns</span><span class="p">,</span> <span class="n">prior</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">prcp</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell tag_hide-cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># Solution</span>

<span class="n">densities</span> <span class="o">=</span> <span class="n">gamma_dist</span><span class="p">(</span><span class="n">k_mesh</span><span class="p">,</span> <span class="n">theta_mesh</span><span class="p">)</span><span class="o">.</span><span class="n">pdf</span><span class="p">(</span><span class="n">data_mesh</span><span class="p">)</span> 
<span class="n">densities</span><span class="o">.</span><span class="n">shape</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-none notranslate"><div class="highlight"><pre><span></span>(101, 101, 14)
</pre></div>
</div>
</div>
</div>
<div class="cell tag_hide-cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># Solution</span>

<span class="n">likelihood</span> <span class="o">=</span> <span class="n">densities</span><span class="o">.</span><span class="n">prod</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
<span class="n">likelihood</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-none notranslate"><div class="highlight"><pre><span></span>601019.972665461
</pre></div>
</div>
</div>
</div>
<div class="cell tag_hide-cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># Solution</span>

<span class="n">posterior</span> <span class="o">=</span> <span class="n">prior</span> <span class="o">*</span> <span class="n">likelihood</span>
<span class="n">normalize</span><span class="p">(</span><span class="n">posterior</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell tag_hide-cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># Solution</span>

<span class="n">plot_contour</span><span class="p">(</span><span class="n">posterior</span><span class="p">)</span>

<span class="n">decorate</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="s1">&#39;Posterior joint distribution, parameters of a gamma distribution&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/chap12_167_0.png" src="_images/chap12_167_0.png" />
</div>
</div>
<div class="cell tag_hide-cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># Solution</span>

<span class="kn">from</span> <span class="nn">utils</span> <span class="kn">import</span> <span class="n">marginal</span>

<span class="n">posterior_k</span> <span class="o">=</span> <span class="n">marginal</span><span class="p">(</span><span class="n">posterior</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
<span class="n">posterior_theta</span> <span class="o">=</span> <span class="n">marginal</span><span class="p">(</span><span class="n">posterior</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell tag_hide-cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># Solution</span>

<span class="n">posterior_k</span><span class="o">.</span><span class="n">plot</span><span class="p">()</span>
<span class="n">decorate</span><span class="p">(</span><span class="n">xlabel</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span>
         <span class="n">ylabel</span><span class="o">=</span><span class="s1">&#39;PDF&#39;</span><span class="p">,</span> 
         <span class="n">title</span><span class="o">=</span><span class="s1">&#39;Posterior marginal distribution of k&#39;</span><span class="p">)</span>

<span class="n">posterior_k</span><span class="o">.</span><span class="n">mean</span><span class="p">(),</span> <span class="n">posterior_k</span><span class="o">.</span><span class="n">credible_interval</span><span class="p">(</span><span class="mf">0.9</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-none notranslate"><div class="highlight"><pre><span></span>(0.84368972214469, array([0.4478, 1.3632]))
</pre></div>
</div>
<img alt="_images/chap12_169_1.png" src="_images/chap12_169_1.png" />
</div>
</div>
<div class="cell tag_hide-cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># Solution</span>

<span class="n">posterior_theta</span><span class="o">.</span><span class="n">plot</span><span class="p">()</span>
<span class="n">decorate</span><span class="p">(</span><span class="n">xlabel</span><span class="o">=</span><span class="s1">&#39;theta&#39;</span><span class="p">,</span>
         <span class="n">ylabel</span><span class="o">=</span><span class="s1">&#39;PDF&#39;</span><span class="p">,</span> 
         <span class="n">title</span><span class="o">=</span><span class="s1">&#39;Posterior marginal distribution of theta&#39;</span><span class="p">)</span>

<span class="n">posterior_theta</span><span class="o">.</span><span class="n">mean</span><span class="p">(),</span> <span class="n">posterior_theta</span><span class="o">.</span><span class="n">credible_interval</span><span class="p">(</span><span class="mf">0.9</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-none notranslate"><div class="highlight"><pre><span></span>(0.3676197943125124, array([0.159 , 0.7997]))
</pre></div>
</div>
<img alt="_images/chap12_170_1.png" src="_images/chap12_170_1.png" />
</div>
</div>
<div class="cell tag_hide-cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># Solution</span>

<span class="k">def</span> <span class="nf">joint_gamma_sample</span><span class="p">(</span><span class="n">joint</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="mi">1000</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Sample from a predictive distribution.</span>
<span class="sd">    </span>
<span class="sd">    joint: joint distribution of parameters</span>
<span class="sd">    n: sample size</span>
<span class="sd">    </span>
<span class="sd">    returns: NumPy array of random values</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">pmf</span> <span class="o">=</span> <span class="n">Pmf</span><span class="p">(</span><span class="n">joint</span><span class="o">.</span><span class="n">stack</span><span class="p">())</span>
    <span class="n">reset</span> <span class="o">=</span> <span class="n">pmf</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
    <span class="n">index</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">reset</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">p</span><span class="o">=</span><span class="n">pmf</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">n</span><span class="p">)</span>
    <span class="n">chosen</span> <span class="o">=</span> <span class="n">reset</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>
    <span class="n">sample</span> <span class="o">=</span> <span class="n">gamma_dist</span><span class="p">(</span><span class="n">chosen</span><span class="p">[</span><span class="s1">&#39;k&#39;</span><span class="p">],</span> <span class="n">chosen</span><span class="p">[</span><span class="s1">&#39;theta&#39;</span><span class="p">])</span><span class="o">.</span><span class="n">rvs</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">sample</span>
</pre></div>
</div>
</div>
</div>
<div class="cell tag_hide-cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># Solution</span>

<span class="n">sample</span> <span class="o">=</span> <span class="n">joint_gamma_sample</span><span class="p">(</span><span class="n">posterior</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell tag_hide-cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># Solution</span>

<span class="n">Cdf</span><span class="o">.</span><span class="n">from_seq</span><span class="p">(</span><span class="n">sample</span><span class="p">)</span><span class="o">.</span><span class="n">plot</span><span class="p">()</span>
<span class="n">decorate</span><span class="p">(</span><span class="n">xlabel</span><span class="o">=</span><span class="s1">&#39;Total rainfall (in)&#39;</span><span class="p">,</span>
         <span class="n">ylabel</span><span class="o">=</span><span class="s1">&#39;CDF&#39;</span><span class="p">,</span>
         <span class="n">title</span><span class="o">=</span><span class="s1">&#39;Posterior predictive distribution of rainfall&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/chap12_173_0.png" src="_images/chap12_173_0.png" />
</div>
</div>
<div class="cell tag_hide-cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># Solution</span>

<span class="c1"># Now let&#39;s estimate the probability of rain</span>

<span class="n">data</span> <span class="o">=</span> <span class="n">rained</span><span class="o">.</span><span class="n">sum</span><span class="p">(),</span> <span class="nb">len</span><span class="p">(</span><span class="n">weather</span><span class="p">)</span>
<span class="n">data</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-none notranslate"><div class="highlight"><pre><span></span>(14, 31)
</pre></div>
</div>
</div>
</div>
<div class="cell tag_hide-cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># Solution</span>

<span class="c1"># Here&#39;s the prior and the update</span>

<span class="n">hypos</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">101</span><span class="p">)</span>
<span class="n">pmf_rain</span> <span class="o">=</span> <span class="n">Pmf</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">hypos</span><span class="p">)</span>
<span class="n">update_binomial</span><span class="p">(</span><span class="n">pmf_rain</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell tag_hide-cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># Solution</span>

<span class="c1"># And the posterior</span>

<span class="n">pmf_rain</span><span class="o">.</span><span class="n">plot</span><span class="p">()</span>
<span class="n">decorate</span><span class="p">(</span><span class="n">xlabel</span><span class="o">=</span><span class="s1">&#39;Probability of rain&#39;</span><span class="p">,</span>
         <span class="n">ylabel</span><span class="o">=</span><span class="s1">&#39;PDF&#39;</span><span class="p">,</span>
         <span class="n">title</span><span class="o">=</span><span class="s1">&#39;Posterior distribution of probability of rain&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/chap12_176_0.png" src="_images/chap12_176_0.png" />
</div>
</div>
<div class="cell tag_hide-cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># Solution</span>

<span class="c1"># For prediction, we only need the posterior mean</span>

<span class="n">p_rain</span> <span class="o">=</span> <span class="n">pmf_rain</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
<span class="n">p_rain</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-none notranslate"><div class="highlight"><pre><span></span>0.4545454545454545
</pre></div>
</div>
</div>
</div>
<div class="cell tag_hide-cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># Solution</span>

<span class="c1"># Here&#39;s a predictive sample for which days it rains</span>

<span class="n">rained</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">sample</span><span class="p">))</span> <span class="o">&lt;</span> <span class="n">p_rain</span>
<span class="n">rained</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-none notranslate"><div class="highlight"><pre><span></span>0.465
</pre></div>
</div>
</div>
</div>
<div class="cell tag_hide-cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># Solution</span>

<span class="c1"># Now to simulate rain days and non-rain days, we can</span>
<span class="c1"># multiplytotal rainfall by Boolean True/False values,</span>
<span class="c1"># which are treated as 1/0</span>

<span class="n">pred</span> <span class="o">=</span> <span class="n">rained</span> <span class="o">*</span> <span class="n">sample</span>
<span class="n">Cdf</span><span class="o">.</span><span class="n">from_seq</span><span class="p">(</span><span class="n">pred</span><span class="p">)</span><span class="o">.</span><span class="n">plot</span><span class="p">()</span>

<span class="n">decorate</span><span class="p">(</span><span class="n">xlabel</span><span class="o">=</span><span class="s1">&#39;Total rainfall (in)&#39;</span><span class="p">,</span>
         <span class="n">ylabel</span><span class="o">=</span><span class="s1">&#39;CDF&#39;</span><span class="p">,</span>
         <span class="n">title</span><span class="o">=</span><span class="s1">&#39;Posterior predictive distribution of rainfall&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/chap12_179_0.png" src="_images/chap12_179_0.png" />
</div>
</div>
</div>
</div>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            kernelName: "python3",
            path: "./."
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

              </div>
              
        </div>
    </div>
    
    
    <div class='prev-next-bottom'>
        

    </div>
    <footer class="footer mt-5 mt-md-0">
    <div class="container">
      <p>
        
          By Allen B. Downey<br/>
        
            &copy; Copyright 2020.<br/>
      </p>
    </div>
  </footer>
</main>


      </div>
    </div>

    <script src="_static/js/index.js"></script>
    
  </body>
</html>